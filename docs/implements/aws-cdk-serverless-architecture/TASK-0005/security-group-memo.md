# TDDé–‹ç™ºãƒ¡ãƒ¢: Security Group Construct

## æ¦‚è¦

- æ©Ÿèƒ½å: Security Group Construct
- é–‹ç™ºé–‹å§‹: 2026-01-17
- ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º: å®Œäº†

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- å…ƒã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«: `docs/tasks/aws-cdk-serverless-architecture/TASK-0005.md`
- è¦ä»¶å®šç¾©: `docs/implements/aws-cdk-serverless-architecture/TASK-0005/security-group-requirements.md`
- ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å®šç¾©: `docs/implements/aws-cdk-serverless-architecture/TASK-0005/security-group-testcases.md`
- å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«: `infra/lib/construct/security/security-group-construct.ts`
- ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: `infra/test/construct/security/security-group-construct.test.ts`

## Redãƒ•ã‚§ãƒ¼ã‚ºï¼ˆå¤±æ•—ã™ã‚‹ãƒ†ã‚¹ãƒˆä½œæˆï¼‰

### ä½œæˆæ—¥æ™‚

2026-01-17

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

ä»¥ä¸‹ã®18å€‹ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ä½œæˆ:

1. **TC-SG-01**: ALB Security Group ä½œæˆç¢ºèª ðŸ”µ
2. **TC-SG-02**: ALB Security Group HTTP(80) ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰è¨±å¯ç¢ºèª ðŸ”µ
3. **TC-SG-03**: ALB Security Group HTTPS(443) ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰è¨±å¯ç¢ºèª ðŸ”µ
4. **TC-SG-04**: ECS Security Group ä½œæˆç¢ºèª ðŸ”µ
5. **TC-SG-05**: ECS Security Group ALB ã‹ã‚‰ã®ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰è¨±å¯ç¢ºèª ðŸ”µ
6. **TC-SG-06**: ECS Security Group ã‚«ã‚¹ã‚¿ãƒ  containerPort ç¢ºèª ðŸ”µ
7. **TC-SG-07**: Aurora Security Group ä½œæˆç¢ºèª ðŸ”µ
8. **TC-SG-08**: Aurora Security Group ECS ã‹ã‚‰ã® 3306 ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰è¨±å¯ç¢ºèª ðŸ”µ
9. **TC-SG-09**: Aurora Security Group å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹é®æ–­ç¢ºèª ðŸ”µ
10. **TC-SG-10**: Aurora Security Group ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰åˆ¶é™ç¢ºèª ðŸ”µ
11. **TC-SG-11**: å…¬é–‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å­˜åœ¨ç¢ºèª ðŸ”µ
12. **TC-SG-16**: containerPort ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ (80) ç¢ºèª ðŸ”µ
13. **TC-SG-17**: ECS SG ãŒ ALB SG ã‚’å‚ç…§ï¼ˆCIDR ãƒ™ãƒ¼ã‚¹ã§ãªã„ã“ã¨ï¼‰ ðŸ”µ
14. **TC-SG-18**: Aurora SG ãŒ ECS SG ã‚’å‚ç…§ï¼ˆCIDR ãƒ™ãƒ¼ã‚¹ã§ãªã„ã“ã¨ï¼‰ ðŸ”µ
15. **TC-SG-19**: ALB SG ã« HTTP/HTTPS ä»¥å¤–ã®ãƒ«ãƒ¼ãƒ«ãŒãªã„ã“ã¨ ðŸ”µ
16. **TC-SG-20**: ECS SG ã« ALB ã‹ã‚‰ã®ãƒ«ãƒ¼ãƒ«ä»¥å¤–ãŒãªã„ã“ã¨ ðŸ”µ
17. **TC-SG-21**: Aurora SG ã« ECS ã‹ã‚‰ã®ãƒ«ãƒ¼ãƒ«ä»¥å¤–ãŒãªã„ã“ã¨ ðŸ”µ
18. **TC-SG-22**: ä½œæˆã•ã‚Œã‚‹ Security Group ãŒ 3 ã¤ã§ã‚ã‚‹ã“ã¨ ðŸ”µ

### æœŸå¾…ã•ã‚Œã‚‹å¤±æ•—

```
FAIL test/construct/security/security-group-construct.test.ts
  â— Test suite failed to run

    Cannot find module '../../../lib/construct/security/security-group-construct'
    or its corresponding type declarations.
```

**å¤±æ•—ç†ç”±**: `SecurityGroupConstruct` ã‚¯ãƒ©ã‚¹ãŒã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€‚

## Greenãƒ•ã‚§ãƒ¼ã‚ºï¼ˆæœ€å°å®Ÿè£…ï¼‰

### å®Ÿè£…æ—¥æ™‚

2026-01-17

### å®Ÿè£…æ–¹é‡

æœ€å°é™ã®å®Ÿè£…ã§ãƒ†ã‚¹ãƒˆã‚’é€šã™:

1. `SecurityGroupConstructProps` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ä½œæˆ
2. `SecurityGroupConstruct` ã‚¯ãƒ©ã‚¹ä½œæˆ
3. ALB Security Group ä½œæˆï¼ˆHTTP/HTTPS è¨±å¯ï¼‰
4. ECS Security Group ä½œæˆï¼ˆALB ã‹ã‚‰ã® containerPort è¨±å¯ï¼‰
5. Aurora Security Group ä½œæˆï¼ˆECS ã‹ã‚‰ã® 3306 è¨±å¯ã€ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰åˆ¶é™ï¼‰
6. å…¬é–‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¨­å®š

### ãƒ†ã‚¹ãƒˆçµæžœ

```
Test Suites: 1 passed, 1 total
Tests:       20 passed, 20 total
```

## Refactorãƒ•ã‚§ãƒ¼ã‚ºï¼ˆå“è³ªæ”¹å–„ï¼‰

### ãƒªãƒ•ã‚¡ã‚¯ã‚¿æ—¥æ™‚

2026-01-17

### æ”¹å–„å†…å®¹

VPC Construct ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°çµæžœã‚’å‚è€ƒã«å®Ÿæ–½:

1. **å®šæ•°ã®æŠ½å‡º** ðŸ”µ
   - ãƒãƒ¼ãƒˆç•ªå·: `DEFAULT_CONTAINER_PORT`, `PORT_HTTP`, `PORT_HTTPS`, `PORT_MYSQL`
   - èª¬æ˜Žæ–‡: `DESCRIPTION_ALB_SG`, `DESCRIPTION_ECS_SG`, `DESCRIPTION_AURORA_SG`

2. **JSDoc ã®å¼·åŒ–** ðŸ”µ
   - ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¿½åŠ 
   - å„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«è©³ç´°ãªèª¬æ˜Žè¿½åŠ 
   - ä½¿ç”¨ä¾‹ã‚’è¿½åŠ 

3. **ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºåˆ‡ã‚Šã®è¿½åŠ ** ðŸ”µ
   - å®šæ•°å®šç¾©ã‚»ã‚¯ã‚·ãƒ§ãƒ³
   - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©ã‚»ã‚¯ã‚·ãƒ§ãƒ³
   - ã‚¯ãƒ©ã‚¹å®Ÿè£…ã‚»ã‚¯ã‚·ãƒ§ãƒ³

4. **å‡¦ç†èª¬æ˜Žã‚³ãƒ¡ãƒ³ãƒˆã®è¿½åŠ ** ðŸ”µ
   - å„è¨­å®šé …ç›®ã®ç›®çš„èª¬æ˜Ž
   - è¦ä»¶ã¨ã®å¯¾å¿œé–¢ä¿‚æ˜Žè¨˜
   - ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«æ˜Žè¨˜

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼

| é …ç›® | è©•ä¾¡ |
|------|------|
| æœ€å°æ¨©é™ã®åŽŸå‰‡ | æº–æ‹  |
| SG-to-SG å‚ç…§ | ä½¿ç”¨ |
| Aurora ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰åˆ¶é™ | æœ‰åŠ¹ |
| è„†å¼±æ€§ | æ¤œå‡ºã•ã‚Œãš |

**ç·åˆè©•ä¾¡**: é«˜å“è³ª

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ¬ãƒ“ãƒ¥ãƒ¼

| é …ç›® | è©•ä¾¡ |
|------|------|
| ãƒªã‚½ãƒ¼ã‚¹ä½œæˆåŠ¹çŽ‡ | æœ€é© |
| è¨ˆç®—é‡ | O(1) |
| ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ | æœ€å°é™ |

**ç·åˆè©•ä¾¡**: é«˜å“è³ª

### æœ€çµ‚ã‚³ãƒ¼ãƒ‰

ãƒ•ã‚¡ã‚¤ãƒ«: `infra/lib/construct/security/security-group-construct.ts`

ã‚³ãƒ¼ãƒ‰è¡Œæ•°: 299è¡Œï¼ˆ500è¡Œåˆ¶é™å†…ï¼‰

### ãƒ†ã‚¹ãƒˆçµæžœï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿å¾Œï¼‰

```
Test Suites: 1 passed, 1 total
Tests:       20 passed, 20 total
```

### ãƒ“ãƒ«ãƒ‰çµæžœ

```
npm run build
# æˆåŠŸï¼ˆã‚¨ãƒ©ãƒ¼ãªã—ï¼‰
```

### å“è³ªè©•ä¾¡

| é …ç›® | çµæžœ |
|------|------|
| ãƒ†ã‚¹ãƒˆçµæžœ | å…¨ã¦ç¶™ç¶šæˆåŠŸ (20/20) |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | é«˜å“è³ª |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ | é«˜å“è³ª |
| ãƒªãƒ•ã‚¡ã‚¯ã‚¿å“è³ª | ç›®æ¨™é”æˆ |
| ã‚³ãƒ¼ãƒ‰å“è³ª | é©åˆ‡ãªãƒ¬ãƒ™ãƒ« |
| ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º | 299è¡Œ (500è¡Œåˆ¶é™å†…) |

**ç·åˆè©•ä¾¡**: âœ… é«˜å“è³ª

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒžãƒªãƒ¼

| ãƒ•ã‚§ãƒ¼ã‚º | ðŸ”µ é’ä¿¡å· | ðŸŸ¡ é»„ä¿¡å· | ðŸ”´ èµ¤ä¿¡å· |
|---------|----------|----------|----------|
| Requirements | 22 (92%) | 2 (8%) | 0 (0%) |
| Testcases | 18 (82%) | 3 (14%) | 1 (4%) |
| Red | 18 (100%) | 0 (0%) | 0 (0%) |
| Refactor | 4 (100%) | 0 (0%) | 0 (0%) |

## Verify Complete ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆå®Œå…¨æ€§æ¤œè¨¼ï¼‰

### æ¤œè¨¼æ—¥æ™‚

2026-01-17

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæžœ

```
Test Suites: 1 passed, 1 total
Tests:       20 passed, 20 total
Snapshots:   0 total
Time:        5.955 s
```

### è¦ä»¶ç¶²ç¾…æ€§ãƒã‚§ãƒƒã‚¯

| å®Œäº†æ¡ä»¶ | çŠ¶æ…‹ | å¯¾å¿œãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ |
|----------|------|-----------------|
| SecurityGroupConstruct ã‚¯ãƒ©ã‚¹å®Ÿè£… | å®Œäº† | TC-SG-01ã€œTC-SG-22 |
| ALB SG ã® HTTP(80)/HTTPS(443) è¨±å¯ | å®Œäº† | TC-SG-01, TC-SG-02, TC-SG-03, TC-SG-19 |
| ECS SG ã® ALB ã‹ã‚‰ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®ã¿è¨±å¯ | å®Œäº† | TC-SG-04, TC-SG-05, TC-SG-17, TC-SG-20 |
| Aurora SG ã® ECS ã‹ã‚‰ã® 3306 ã®ã¿è¨±å¯ | å®Œäº† | TC-SG-07, TC-SG-08, TC-SG-18, TC-SG-21 |
| Aurora SG ã®å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹é®æ–­ | å®Œäº† | TC-SG-09, TC-SG-10 |
| å˜ä½“ãƒ†ã‚¹ãƒˆå…¨æˆåŠŸ | å®Œäº† | å…¨20ãƒ†ã‚¹ãƒˆæˆåŠŸ |

- **è¦ä»¶é …ç›®ç·æ•°**: 6é …ç›®
- **å®Ÿè£…æ¸ˆã¿é …ç›®**: 6é …ç›®
- **è¦ä»¶ç¶²ç¾…çŽ‡**: 100%

### å®Ÿè£…çŽ‡ã‚µãƒžãƒªãƒ¼

| åˆ†é¡ž | å®Ÿè£…æ•° | äºˆå®šæ•° | å®Ÿè£…çŽ‡ |
|------|--------|--------|--------|
| æ­£å¸¸ç³» | 11 | 11 | 100% |
| ç•°å¸¸ç³» | 5 | 5 | 100% |
| ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ | 2 | 2 | 100% |
| ãã®ä»– | 2 | 2 | 100% |
| **åˆè¨ˆ** | **20** | **20** | **100%** |

### å“è³ªåˆ¤å®š

**é«˜å“è³ªï¼ˆè¦ä»¶å……å®Ÿåº¦å®Œå…¨é”æˆï¼‰**
- æ—¢å­˜ãƒ†ã‚¹ãƒˆçŠ¶æ…‹: ã™ã¹ã¦ã‚°ãƒªãƒ¼ãƒ³ (20/20)
- è¦ä»¶ç¶²ç¾…çŽ‡: 100%
- ãƒ†ã‚¹ãƒˆæˆåŠŸçŽ‡: 100%
- æœªå®Ÿè£…é‡è¦è¦ä»¶: 0å€‹

### æœ€çµ‚çµæžœ

- **å®Ÿè£…çŽ‡**: 100% (20/20ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹)
- **å“è³ªåˆ¤å®š**: åˆæ ¼
- **ã‚¿ã‚¹ã‚¯çŠ¶æ…‹**: å®Œäº†

---

## é‡è¦ãªæŠ€è¡“å­¦ç¿’ï¼ˆå†åˆ©ç”¨å¯èƒ½ï¼‰

### å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

1. **Security Group ã® SG-to-SG å‚ç…§ãƒ‘ã‚¿ãƒ¼ãƒ³**
   - CIDR ãƒ™ãƒ¼ã‚¹ã§ã¯ãªã Security Group ã‚’ç›´æŽ¥å‚ç…§ã™ã‚‹ã“ã¨ã§ã€å‹•çš„ IP å¤‰æ›´ã«å¯¾å¿œ
   - `ecsSecurityGroup.addIngressRule(albSecurityGroup, ...)` ã®ã‚ˆã†ã« SG ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã™

2. **æœ€å°æ¨©é™ã®åŽŸå‰‡ã®å®Ÿè£…**
   - ALB SG: HTTP(80) ã¨ HTTPS(443) ã®ã¿ã‚’ 0.0.0.0/0 ã‹ã‚‰è¨±å¯
   - ECS SG: ALB SG ã‹ã‚‰ã® containerPort ã®ã¿è¨±å¯
   - Aurora SG: ECS SG ã‹ã‚‰ã® 3306 ã®ã¿è¨±å¯ã€`allowAllOutbound: false` ã§å¤–éƒ¨æŽ¥ç¶šã‚’é®æ–­

3. **å®šæ•°æŠ½å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³**
   - ãƒãƒ¼ãƒˆç•ªå·ã‚’ `PORT_HTTP`, `PORT_HTTPS`, `PORT_MYSQL` ã¨ã—ã¦å®šæ•°åŒ–
   - èª¬æ˜Žæ–‡ã‚’ `DESCRIPTION_*_SG` ã¨ã—ã¦å®šæ•°åŒ–

### ãƒ†ã‚¹ãƒˆè¨­è¨ˆ

1. **CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼**
   - `Template.fromStack()` ã§ã‚¹ã‚¿ãƒƒã‚¯ã‚’ CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å¤‰æ›
   - `hasResourceProperties()` ã§ãƒªã‚½ãƒ¼ã‚¹ã®å­˜åœ¨ã¨è¨­å®šã‚’æ¤œè¨¼
   - `findResources()` ã§è¤‡æ•°ãƒªã‚½ãƒ¼ã‚¹ã®å–å¾—ã¨æ¤œè¨¼

2. **SecurityGroup Ingress ãƒ«ãƒ¼ãƒ«ã®ãƒ†ã‚¹ãƒˆ**
   - ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®šç¾©: `SecurityGroupIngress` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å†…ã®é…åˆ—ã‚’ãƒã‚§ãƒƒã‚¯
   - åˆ¥ãƒªã‚½ãƒ¼ã‚¹å®šç¾©: `AWS::EC2::SecurityGroupIngress` ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯

### è¦ä»¶å¯¾å¿œè¡¨

| è¦ä»¶ID | è¦ä»¶å†…å®¹ | å®Ÿè£…çŠ¶æ³ |
|--------|----------|----------|
| REQ-024 | Aurora SG ã§å¤–éƒ¨ã‹ã‚‰ã®ç›´æŽ¥ã‚¢ã‚¯ã‚»ã‚¹ã‚’é®æ–­ | å®Œäº† |
| REQ-025 | Aurora SG ã§ ECS SG ã‹ã‚‰ã® 3306 ã®ã¿è¨±å¯ | å®Œäº† |
| REQ-028 | ALB ã‚’ Public Subnet ã«é…ç½®ã€Internet-facing | å®Œäº† |
| REQ-029 | HTTP->HTTPS ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¯¾å¿œ | å®Œäº† |

---
*TDD é–‹ç™ºå®Œäº† - 2026-01-17*
