# TASK-0009: Secrets Manager 統合 ✅ **完了** (TDD開発完了 - 10テストケース全通過)

**タスクID**: TASK-0009
**タスクタイプ**: TDD
**推定工数**: 4時間
**フェーズ**: Phase 2 - セキュリティ・データベース
**信頼性レベル**: 🟡 *AWS ベストプラクティスから推測*
**完了日**: 2026-01-20

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/aws-cdk-serverless-architecture/requirements.md) - REQ-022 (Aurora credentials)
- **設計文書**: [📐 architecture.md](../../design/aws-cdk-serverless-architecture/architecture.md)

## タスク概要

Aurora データベースの認証情報を AWS Secrets Manager で安全に管理するための統合を実装します。ECS タスクからのシークレット参照、自動ローテーション設定、暗号化設定を含みます。

## 依存タスク

- **前提タスク**: [TASK-0008](TASK-0008.md) Aurora Construct 実装
- **後続タスク**: [TASK-0010](TASK-0010.md) Database Stack 統合

## 完了条件

- [x] Aurora クラスターの認証情報が Secrets Manager で管理されている
- [x] ECS タスク定義からシークレット参照が可能である
- [x] シークレットの暗号化（KMS）が有効になっている
- [x] 自動ローテーションが設定されている（オプション）- *将来の拡張として設計済み*
- [x] すべてのユニットテストが通過している

---

## 主要実装項目

### Secrets Manager シークレット作成 🟡

**信頼性**: 🟡 *AWS ベストプラクティスから推測*

Aurora クラスター用のシークレットを Secrets Manager で作成します。DatabaseSecret クラスを使用し、Aurora クラスターとの自動統合を実現します。

```typescript
export interface SecretsManagerConstructProps {
  auroraCluster: rds.IDatabaseCluster;
  envName: string;
  rotationDays?: number;  // default: 30
}
```

**実装ファイル**: `lib/construct/secrets-manager-construct.ts`

### ECS タスク連携 🟡

**信頼性**: 🟡 *AWS ベストプラクティスから推測*

ECS タスク定義からシークレットを参照するための設定。環境変数としてのシークレット注入、タスク実行ロールへの権限付与を含みます。

```typescript
// ECS タスク定義でのシークレット参照例
secrets: {
  DB_PASSWORD: ecs.Secret.fromSecretsManager(dbSecret, 'password'),
  DB_USERNAME: ecs.Secret.fromSecretsManager(dbSecret, 'username'),
}
```

**実装ファイル**: `lib/construct/secrets-manager-construct.ts`

### 暗号化設定 🔵

**信頼性**: 🔵 *AWS セキュリティベストプラクティス*

Secrets Manager シークレットの KMS 暗号化設定。カスタマーマネージドキー（CMK）の使用オプションを提供します。

**実装ファイル**: `lib/construct/secrets-manager-construct.ts`

### 自動ローテーション設定 🟡

**信頼性**: 🟡 *AWS ベストプラクティスから推測*

Aurora との統合によるシークレット自動ローテーション。ローテーション Lambda 関数の自動作成、ローテーション間隔の設定（デフォルト30日）を含みます。

**実装ファイル**: `lib/construct/secrets-manager-construct.ts`

---

## 基本的なテスト要件

### シークレット作成テスト 🔵

**信頼性**: 🔵 *CDK テストパターン*

- Secrets Manager シークレットリソースが作成されること
- Aurora クラスターとの関連付けが正しいこと

### 暗号化テスト 🔵

**信頼性**: 🔵 *セキュリティ要件*

- KMS 暗号化が有効であること
- 適切な暗号化キーが使用されていること

### IAM ポリシーテスト 🟡

**信頼性**: 🟡 *AWS ベストプラクティスから推測*

- ECS タスク実行ロールにシークレット読み取り権限があること
- 最小権限の原則が適用されていること

---

## 実装手順

### TDDタスクの場合

1. `/tsumiki:tdd-requirements TASK-0009` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 信頼性レベルサマリー

- **総項目数**: 7項目
- 🔵 **青信号**: 3項目 (43%)
- 🟡 **黄信号**: 4項目 (57%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 要改善（AWS ベストプラクティスに基づく推測が多いため、実装時に確認が必要）
