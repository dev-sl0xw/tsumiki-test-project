# TASK-0023: CI/CD Pipeline 構築 ✅ **完了** (TDD開発完了 - 31テストケース全通過)

**タスクID**: TASK-0023
**タスクタイプ**: TDD
**推定工数**: 8時間
**フェーズ**: Phase 4 - 配信・運用
**信頼性レベル**: 🟡 *要件定義書 REQ-040, REQ-041より (詳細設計は推測)*
**完了日時**: 2026-02-02

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/aws-cdk-serverless-architecture/requirements.md) - REQ-040, REQ-041
- **設計文書**: [📐 architecture.md](../../design/aws-cdk-serverless-architecture/architecture.md)

## タスク概要

CodeCommit、CodeBuild、CodePipeline を使用した CI/CD パイプラインを構築する。ソースコードのコミットをトリガーとして、ビルド、テスト、ECS へのデプロイを自動化する。パイプラインの各ステージで適切な承認フローと通知を設定する。

## 依存タスク

- **前提タスク**: [TASK-0017](TASK-0017.md) - WAF Construct 実装 (Application Stack 完了後)
- **後続タスク**: [TASK-0024](TASK-0024.md) - Ops Stack 統合 + 最終統合テスト

## 完了条件

- [x] CodeCommit リポジトリが作成される
- [x] CodeBuild プロジェクトが作成される
- [x] CodePipeline が作成される
- [x] Source → Build → Deploy ステージが構成される
- [x] ECS Blue/Green または Rolling デプロイが設定される
- [x] パイプライン通知が SNS/Chatbot に送信される
- [x] 全てのユニットテストが通過する

---

## 主要実装項目

### CodeCommit リポジトリ 🔵

**信頼性**: 🔵 *設計文書より*

アプリケーションコード管理用の CodeCommit リポジトリを作成する。

**設定項目**:
- リポジトリ名: `{env-name}-app-repository`
- ブランチ: `main` (Prod), `develop` (Dev)

**実装ファイル**: `lib/construct/cicd/codecommit-construct.ts`

### CodeBuild プロジェクト 🟡

**信頼性**: 🟡 *要件定義書 REQ-041から妥当な推測*

アプリケーションのビルドとテストを実行する CodeBuild プロジェクトを作成する。

**設定項目**:
- 環境: `LinuxBuildImage.STANDARD_7_0`
- コンピュートタイプ: `BUILD_GENERAL1_SMALL`
- 特権モード: 有効 (Docker ビルド用)
- buildspec.yml: リポジトリ内に配置

**ビルドステップ (推測)**:
1. 依存関係インストール
2. ユニットテスト実行
3. Docker イメージビルド
4. ECR へプッシュ

**実装ファイル**: `lib/construct/cicd/codebuild-construct.ts`

### CodePipeline 🟡

**信頼性**: 🟡 *要件定義書 REQ-041から妥当な推測*

Source → Build → Deploy のパイプラインを構成する。

**ステージ構成**:
1. Source: CodeCommit からソース取得
2. Build: CodeBuild でビルド・テスト・イメージプッシュ
3. Deploy: ECS Service へデプロイ

**設定項目**:
- アーティファクトバケット: S3
- 手動承認: Prod 環境のみ (オプション)

**実装ファイル**: `lib/construct/cicd/codepipeline-construct.ts`

### ECS Deploy Action 🟡

**信頼性**: 🟡 *要件定義書 REQ-041から妥当な推測*

ECS Service へのデプロイアクションを設定する。

**デプロイ方式**:
- Rolling Update (推奨)
- または Blue/Green デプロイ (CodeDeploy 使用)

**設定項目**:
- imagedefinitions.json による Task Definition 更新
- デプロイ設定 (最小ヘルシータスク率など)

**実装ファイル**: `lib/construct/cicd/codepipeline-construct.ts`

### パイプライン通知 🔵

**信頼性**: 🔵 *要件定義書 REQ-039に準拠*

パイプライン実行結果を SNS/Chatbot 経由で通知する。

**通知イベント**:
- パイプライン開始
- ステージ成功/失敗
- 手動承認待ち (Prod のみ)

**実装ファイル**: `lib/construct/cicd/codepipeline-construct.ts`

---

## 基本的なテスト要件

### CodeCommit テスト 🔵

**信頼性**: 🔵 *設計文書より*

- CodeCommit リポジトリが作成されること
- 適切な命名規則が適用されること

### CodeBuild テスト 🟡

**信頼性**: 🟡 *要件定義書 REQ-041から推測*

- CodeBuild プロジェクトが作成されること
- 適切な環境設定がされること
- IAM ロールが正しく設定されること

### CodePipeline テスト 🟡

**信頼性**: 🟡 *要件定義書 REQ-041から推測*

- CodePipeline が作成されること
- Source, Build, Deploy ステージが存在すること
- 各ステージの接続が正しく設定されること

### ECS Deploy テスト 🟡

**信頼性**: 🟡 *要件定義書 REQ-041から推測*

- ECS Deploy アクションが設定されること
- 正しい ECS Service をターゲットとすること

### 通知テスト 🔵

**信頼性**: 🔵 *要件定義書 REQ-039より*

- パイプライン通知ルールが作成されること
- SNS Topic との接続が設定されること

---

## 実装手順

### TDDタスクの場合

1. `/tsumiki:tdd-requirements TASK-0023` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 備考

このタスクは要件定義書で CI/CD の必要性は明確に述べられているものの (REQ-040, REQ-041)、詳細なパイプライン構成については推測に基づいている部分があります。実装前に以下の点を確認することを推奨します:

- ブランチ戦略の詳細
- 手動承認フローの要否
- Blue/Green vs Rolling Update の選択
- buildspec.yml の詳細内容

---

## 信頼性レベルサマリー

- **総項目数**: 10項目
- 🔵 **青信号**: 4項目 (40%)
- 🟡 **黄信号**: 6項目 (60%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 要改善 - CI/CD の詳細設計について追加ヒアリングを推奨
