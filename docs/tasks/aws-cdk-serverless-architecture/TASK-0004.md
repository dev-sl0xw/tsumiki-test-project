# TASK-0004: VPC Stack çµ±åˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0004
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 1 - åŸºç›¤æ§‹ç¯‰
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¦ä»¶å®šç¾©æ›¸ãƒ»è¨­è¨ˆæ–‡æ›¸ã‚ˆã‚Š*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](overview.md)
- **è¦ä»¶å®šç¾©**: [ğŸ“‹ requirements.md](../../spec/aws-cdk-serverless-architecture/requirements.md) - REQ-001ã€œ011
- **è¨­è¨ˆæ–‡æ›¸**: [ğŸ“ architecture.md](../../design/aws-cdk-serverless-architecture/architecture.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

VPC Construct ã¨ VPC Endpoints Construct ã‚’çµ±åˆã—ãŸ VPC Stack ã‚’ä½œæˆã™ã‚‹ã€‚Stack ã¨ã—ã¦ä»–ã® Stack ã‹ã‚‰å‚ç…§å¯èƒ½ãªå½¢ã§ VPC ãƒªã‚½ãƒ¼ã‚¹ã‚’å…¬é–‹ã—ã€ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆã«ã‚ˆã‚Š CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ­£ç¢ºæ€§ã‚’æ¤œè¨¼ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: [TASK-0002](TASK-0002.md) (VPC Construct å®Ÿè£…), [TASK-0003](TASK-0003.md) (VPC Endpoints Construct å®Ÿè£…)
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: [TASK-0005](TASK-0005.md) (Security Group Construct å®Ÿè£…), [TASK-0006](TASK-0006.md) (IAM Role Construct å®Ÿè£…)

## å®Œäº†æ¡ä»¶

- [ ] VpcStack ã‚¯ãƒ©ã‚¹ãŒ lib/stack/vpc-stack.ts ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] VpcConstruct ã¨ EndpointsConstruct ãŒ VpcStack å†…ã§çµ±åˆã•ã‚Œã¦ã„ã‚‹
- [ ] VPCã€ã‚µãƒ–ãƒãƒƒãƒˆã€Endpoint ãŒä»– Stack ã‹ã‚‰å‚ç…§å¯èƒ½ãªå½¢ã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹
- [ ] `cdk synth` ã§æ­£ã—ã„ CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã‚‹

---

## ä¸»è¦å®Ÿè£…é …ç›®

### VPC Stack å®šç¾© ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¨­è¨ˆæ–‡æ›¸ã‚ˆã‚Š*

VpcConstruct ã¨ EndpointsConstruct ã‚’çµ„ã¿åˆã‚ã›ãŸ Stack ã‚’å®šç¾©ã™ã‚‹ã€‚

```typescript
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { VpcConstruct } from '../construct/vpc/vpc-construct';
import { EndpointsConstruct } from '../construct/vpc/endpoints-construct';
import { EnvironmentConfig } from '../../parameter';

export interface VpcStackProps extends cdk.StackProps {
  config: EnvironmentConfig;
}

export class VpcStack extends cdk.Stack {
  public readonly vpc: ec2.IVpc;
  public readonly publicSubnets: ec2.ISubnet[];
  public readonly privateAppSubnets: ec2.ISubnet[];
  public readonly privateDbSubnets: ec2.ISubnet[];

  constructor(scope: Construct, id: string, props: VpcStackProps) {
    super(scope, id, props);

    const vpcConstruct = new VpcConstruct(this, 'Vpc', {
      cidr: props.config.vpcCidr,
    });

    new EndpointsConstruct(this, 'Endpoints', {
      vpc: vpcConstruct.vpc,
    });

    this.vpc = vpcConstruct.vpc;
    this.publicSubnets = vpcConstruct.publicSubnets;
    this.privateAppSubnets = vpcConstruct.privateAppSubnets;
    this.privateDbSubnets = vpcConstruct.privateDbSubnets;
  }
}
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/stack/vpc-stack.ts`

---

### Stack é–“å‚ç…§ã®å…¬é–‹ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *CDK ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚ˆã‚Š*

ä»–ã® Stack ã‹ã‚‰ VPC ãƒªã‚½ãƒ¼ã‚¹ã‚’å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å…¬é–‹ã™ã‚‹ã€‚

| ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ | å‹ | ç”¨é€” |
|-----------|-----|------|
| vpc | ec2.IVpc | VPC å‚ç…§ |
| publicSubnets | ec2.ISubnet[] | ALB é…ç½®ç”¨ |
| privateAppSubnets | ec2.ISubnet[] | ECS é…ç½®ç”¨ |
| privateDbSubnets | ec2.ISubnet[] | Aurora é…ç½®ç”¨ |

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/stack/vpc-stack.ts`

---

### CDK App ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆæ›´æ–° ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¨­è¨ˆæ–‡æ›¸ã‚ˆã‚Š*

bin/app.ts ã§ VpcStack ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã™ã‚‹ã€‚

```typescript
import { App } from 'aws-cdk-lib';
import { VpcStack } from '../lib/stack/vpc-stack';
import { devConfig, prodConfig } from '../parameter';

const app = new App();

const env = app.node.tryGetContext('env') || 'dev';
const config = env === 'prod' ? prodConfig : devConfig;

const vpcStack = new VpcStack(app, `VpcStack-${config.envName}`, {
  config,
  env: {
    account: config.account,
    region: config.region,
  },
});
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `bin/app.ts`

---

## åŸºæœ¬çš„ãªãƒ†ã‚¹ãƒˆè¦ä»¶

### ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *CDK ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚ˆã‚Š*

CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã™ã‚‹ã€‚

```typescript
import * as cdk from 'aws-cdk-lib';
import { Template } from 'aws-cdk-lib/assertions';
import { VpcStack } from '../lib/stack/vpc-stack';
import { devConfig } from '../parameter';

describe('VpcStack', () => {
  test('snapshot', () => {
    const app = new cdk.App();
    const stack = new VpcStack(app, 'TestVpcStack', {
      config: devConfig,
    });
    const template = Template.fromStack(stack);
    expect(template.toJSON()).toMatchSnapshot();
  });
});
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `test/vpc-stack.test.ts`

---

### ãƒªã‚½ãƒ¼ã‚¹å­˜åœ¨ç¢ºèªãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¦ä»¶å®šç¾©æ›¸ REQ-001ã€œ011ã‚ˆã‚Š*

- VPC ãŒ 1ã¤ä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- Subnet ãŒ 6ã¤ï¼ˆPublic x2, PrivateApp x2, PrivateDb x2ï¼‰ä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- Internet Gateway ãŒ 1ã¤ä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- NAT Gateway ãŒ 2ã¤ä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- VPC Endpoint ãŒ 7ã¤ï¼ˆInterface x6, Gateway x1ï¼‰ä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨

---

### Stack å‡ºåŠ›ç¢ºèªãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *CDK ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚ˆã‚Š*

- vpc ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒæ­£ã—ãå…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã“ã¨
- ã‚µãƒ–ãƒãƒƒãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒæ­£ã—ãå…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã“ã¨

---

## å®Ÿè£…æ‰‹é †

### TDDã‚¿ã‚¹ã‚¯ã®å ´åˆ

1. `/tsumiki:tdd-requirements TASK-0004` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 6é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 6é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
