# TASK-0006: IAM Role Construct å®Ÿè£… âœ… **å®Œäº†** (TDDé–‹ç™ºå®Œäº† - 16ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å…¨é€šé)

**ã‚¿ã‚¹ã‚¯ID**: TASK-0006
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 1 - åŸºç›¤æ§‹ç¯‰
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¦ä»¶å®šç¾©æ›¸ãƒ»è¨­è¨ˆæ–‡æ›¸ã‚ˆã‚Š*
**å®Œäº†æ—¥**: 2026-01-18

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](overview.md)
- **è¦ä»¶å®šç¾©**: [ğŸ“‹ requirements.md](../../spec/aws-cdk-serverless-architecture/requirements.md) - REQ-018
- **è¨­è¨ˆæ–‡æ›¸**: [ğŸ“ architecture.md](../../design/aws-cdk-serverless-architecture/architecture.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ECS ã‚¿ã‚¹ã‚¯ã«å¿…è¦ãª IAM Role ã‚’å®šç¾©ã™ã‚‹ Construct ã‚’ä½œæˆã™ã‚‹ã€‚ECS Task Role ã«ã¯ `AmazonSSMManagedInstanceCore` ãƒãƒªã‚·ãƒ¼ã‚’ä»˜ä¸ã—ã¦ ECS Exec ã‚’æœ‰åŠ¹åŒ–ã—ã€ECS Task Execution Role ã«ã¯ ECR ã‹ã‚‰ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ Pull ã¨ CloudWatch Logs ã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: [TASK-0004](TASK-0004.md) (VPC Stack çµ±åˆ)
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: Phase 2 - Application Stack

## å®Œäº†æ¡ä»¶

- [x] IamRoleConstruct ã‚¯ãƒ©ã‚¹ãŒ lib/construct/security/iam-role-construct.ts ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [x] ECS Task Role ãŒä½œæˆã•ã‚Œã€AmazonSSMManagedInstanceCore ãƒãƒªã‚·ãƒ¼ãŒã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ã‚‹
- [x] ECS Task Execution Role ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [x] Task Execution Role ã« ECR èª­ã¿å–ã‚Šæ¨©é™ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹
- [x] Task Execution Role ã« CloudWatch Logs æ›¸ãè¾¼ã¿æ¨©é™ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹
- [x] å˜ä½“ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦æˆåŠŸã™ã‚‹

---

## ä¸»è¦å®Ÿè£…é …ç›®

### ECS Task Role ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¦ä»¶å®šç¾©æ›¸ REQ-018ã‚ˆã‚Š*

ECS ã‚¿ã‚¹ã‚¯ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚ã«ä½¿ç”¨ã™ã‚‹ IAM Role ã‚’ä½œæˆã™ã‚‹ã€‚ECS Exec (SSM Session Manager) ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã€`AmazonSSMManagedInstanceCore` ãƒãƒãƒ¼ã‚¸ãƒ‰ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ã€‚

```typescript
const taskRole = new iam.Role(this, 'EcsTaskRole', {
  assumedBy: new iam.ServicePrincipal('ecs-tasks.amazonaws.com'),
  description: 'IAM role for ECS Fargate tasks',
});

taskRole.addManagedPolicy(
  iam.ManagedPolicy.fromAwsManagedPolicyName('AmazonSSMManagedInstanceCore')
);
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/security/iam-role-construct.ts`

---

### ECS Task Execution Role ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ECS Fargate è¦ä»¶ã‚ˆã‚Š*

ECS ã‚µãƒ¼ãƒ“ã‚¹ãŒã‚¿ã‚¹ã‚¯ã‚’èµ·å‹•ã™ã‚‹éš›ã«ä½¿ç”¨ã™ã‚‹ IAM Role ã‚’ä½œæˆã™ã‚‹ã€‚ECR ã‹ã‚‰ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ Pull ã¨ CloudWatch Logs ã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã€‚

```typescript
const executionRole = new iam.Role(this, 'EcsTaskExecutionRole', {
  assumedBy: new iam.ServicePrincipal('ecs-tasks.amazonaws.com'),
  description: 'IAM role for ECS task execution',
});

executionRole.addManagedPolicy(
  iam.ManagedPolicy.fromAwsManagedPolicyName('service-role/AmazonECSTaskExecutionRolePolicy')
);
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/security/iam-role-construct.ts`

---

### Secrets Manager ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *Aurora èªè¨¼æƒ…å ±ç®¡ç†è¦ä»¶ã‚ˆã‚Š*

Task Role ã« Secrets Manager ã‹ã‚‰ã® DB èªè¨¼æƒ…å ±èª­ã¿å–ã‚Šæ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã€‚

```typescript
taskRole.addToPolicy(new iam.PolicyStatement({
  effect: iam.Effect.ALLOW,
  actions: [
    'secretsmanager:GetSecretValue',
  ],
  resources: ['*'], // æœ¬ç•ªã§ã¯ç‰¹å®šã® Secret ARN ã«åˆ¶é™
}));
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/security/iam-role-construct.ts`

---

### æœ€å°æ¨©é™ã®åŸå‰‡é©ç”¨ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚ˆã‚Š*

å„ Role ã«å¿…è¦æœ€å°é™ã®æ¨©é™ã®ã¿ã‚’ä»˜ä¸ã™ã‚‹ã€‚

| Role | æ¨©é™ | ç”¨é€” |
|------|------|------|
| Task Role | AmazonSSMManagedInstanceCore | ECS Exec |
| Task Role | secretsmanager:GetSecretValue | DB èªè¨¼æƒ…å ±å–å¾— |
| Execution Role | AmazonECSTaskExecutionRolePolicy | ECR Pull, CloudWatch Logs |

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/security/iam-role-construct.ts`

---

## åŸºæœ¬çš„ãªãƒ†ã‚¹ãƒˆè¦ä»¶

### ECS Task Role ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¦ä»¶å®šç¾©æ›¸ REQ-018ã‚ˆã‚Š*

- ECS Task Role ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- ecs-tasks.amazonaws.com ãŒ AssumeRole ã§ãã‚‹ã“ã¨
- AmazonSSMManagedInstanceCore ãƒãƒªã‚·ãƒ¼ãŒã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ã‚‹ã“ã¨

### ECS Task Execution Role ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ECS Fargate è¦ä»¶ã‚ˆã‚Š*

- ECS Task Execution Role ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- ecs-tasks.amazonaws.com ãŒ AssumeRole ã§ãã‚‹ã“ã¨
- AmazonECSTaskExecutionRolePolicy ãƒãƒªã‚·ãƒ¼ãŒã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ã‚‹ã“ã¨

### Secrets Manager æ¨©é™ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *Aurora èªè¨¼æƒ…å ±ç®¡ç†è¦ä»¶ã‚ˆã‚Š*

- Task Role ã« secretsmanager:GetSecretValue æ¨©é™ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨

### æœ€å°æ¨©é™ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚ˆã‚Š*

- ä¸è¦ãªæ¨©é™ãŒå«ã¾ã‚Œã¦ã„ãªã„ã“ã¨
- ç®¡ç†è€…æ¨©é™ (AdministratorAccess ç­‰) ãŒã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ãªã„ã“ã¨

---

## å®Ÿè£…æ‰‹é †

### TDDã‚¿ã‚¹ã‚¯ã®å ´åˆ

1. `/tsumiki:tdd-requirements TASK-0006` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 8é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 8é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
