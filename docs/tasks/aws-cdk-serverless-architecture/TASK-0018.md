# TASK-0018: S3 + OAC Construct 実装

**タスクID**: TASK-0018
**タスクタイプ**: TDD
**推定工数**: 4時間
**フェーズ**: Phase 4 - 配信・運用
**信頼性レベル**: 🔵 *要件定義書 REQ-031, REQ-032より*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/aws-cdk-serverless-architecture/requirements.md) - REQ-031, REQ-032
- **設計文書**: [📐 architecture.md](../../design/aws-cdk-serverless-architecture/architecture.md)

## タスク概要

静的コンテンツおよび Sorry Page 提供用の S3 バケットと、CloudFront からのみアクセス可能にするための OAC (Origin Access Control) 設定を実装する。S3 バケットへの直接アクセスを禁止し、CloudFront 経由でのみコンテンツ配信を行う構成とする。

## 依存タスク

- **前提タスク**: [TASK-0017](TASK-0017.md) - WAF Construct 実装
- **後続タスク**: [TASK-0019](TASK-0019.md) - CloudFront Construct 実装

## 完了条件

- [ ] 静的コンテンツ用 S3 バケットが作成される
- [ ] S3 バケットへの直接パブリックアクセスがブロックされる
- [ ] OAC 設定が正しく構成される
- [ ] CloudFront からの署名付きリクエストのみ許可するバケットポリシーが設定される
- [ ] Sorry Page 用のデフォルトエラーページ設定が可能である
- [ ] 全てのユニットテストが通過する

---

## 主要実装項目

### S3 バケット作成 🔵

**信頼性**: 🔵 *要件定義書 REQ-031より*

静的リソースおよび Sorry Page 提供用の S3 バケットを作成する。

**設定項目**:
- `blockPublicAccess`: `BlockPublicAccess.BLOCK_ALL` でパブリックアクセスを完全ブロック
- `encryption`: `BucketEncryption.S3_MANAGED` でサーバーサイド暗号化
- `versioned`: true でバージョニング有効化
- `removalPolicy`: 環境に応じた削除ポリシー

**実装ファイル**: `lib/construct/storage/s3-bucket-construct.ts`

### OAC (Origin Access Control) 設定 🔵

**信頼性**: 🔵 *要件定義書 REQ-032より*

S3 バケットが CloudFront を通じてのみアクセス可能になるよう OAC を構成する。

**設定項目**:
- `originAccessControl`: CloudFront OAC リソース作成
- `signingBehavior`: `always` で常に署名
- `signingProtocol`: `sigv4` で SigV4 署名

**実装ファイル**: `lib/construct/storage/s3-bucket-construct.ts`

### バケットポリシー設定 🔵

**信頼性**: 🔵 *要件定義書 REQ-032より*

CloudFront ディストリビューションからのアクセスのみを許可するバケットポリシーを設定する。

**ポリシー内容**:
- Principal: `cloudfront.amazonaws.com`
- Action: `s3:GetObject`
- Condition: `aws:SourceArn` で特定の CloudFront ディストリビューションを指定

**実装ファイル**: `lib/construct/storage/s3-bucket-construct.ts`

---

## 基本的なテスト要件

### S3 バケット作成テスト 🔵

**信頼性**: 🔵 *要件定義書 REQ-031より*

- S3 バケットリソースが作成されること
- パブリックアクセスブロック設定が有効であること
- サーバーサイド暗号化が有効であること

### OAC 設定テスト 🔵

**信頼性**: 🔵 *要件定義書 REQ-032より*

- OAC リソースが作成されること
- 署名設定が正しく構成されること

### バケットポリシーテスト 🔵

**信頼性**: 🔵 *要件定義書 REQ-032より*

- バケットポリシーが設定されること
- CloudFront からのアクセスのみ許可されること

---

## 実装手順

### TDDタスクの場合

1. `/tsumiki:tdd-requirements TASK-0018` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 信頼性レベルサマリー

- **総項目数**: 6項目
- 🔵 **青信号**: 6項目 (100%)
- 🟡 **黄信号**: 0項目 (0%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 高品質 - 全ての項目が要件定義書により確認済み
