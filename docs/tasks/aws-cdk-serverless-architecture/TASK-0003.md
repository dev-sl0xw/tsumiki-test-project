# TASK-0003: VPC Endpoints Construct å®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0003
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 6æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 1 - åŸºç›¤æ§‹ç¯‰
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¦ä»¶å®šç¾©æ›¸ãƒ»è¨­è¨ˆæ–‡æ›¸ã‚ˆã‚Š*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](overview.md)
- **è¦ä»¶å®šç¾©**: [ğŸ“‹ requirements.md](../../spec/aws-cdk-serverless-architecture/requirements.md) - REQ-008, REQ-009, REQ-010, REQ-011
- **è¨­è¨ˆæ–‡æ›¸**: [ğŸ“ architecture.md](../../design/aws-cdk-serverless-architecture/architecture.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

VPC Endpoint ã‚’å®Ÿè£…ã™ã‚‹ Construct ã‚’ä½œæˆã™ã‚‹ã€‚Systems Manager (ssm, ssmmessages, ec2messages)ã€ECR (ecr.api, ecr.dkr)ã€CloudWatch Logs (logs) ç”¨ã® Interface Endpointã€ãŠã‚ˆã³ S3 ç”¨ã® Gateway Endpoint ã‚’ä½œæˆã—ã€VPC å†…éƒ¨é€šä¿¡ã®æœ€é©åŒ–ã¨ã‚³ã‚¹ãƒˆå‰Šæ¸›ã‚’å®Ÿç¾ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: [TASK-0002](TASK-0002.md) (VPC Construct å®Ÿè£…)
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: [TASK-0004](TASK-0004.md) (VPC Stack çµ±åˆ)

## å®Œäº†æ¡ä»¶

- [ ] EndpointsConstruct ã‚¯ãƒ©ã‚¹ãŒ lib/construct/vpc/endpoints-construct.ts ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] SSM ç”¨ VPC Endpoint (ssm, ssmmessages, ec2messages) ãŒä½œæˆã•ã‚Œã‚‹
- [ ] ECR ç”¨ VPC Endpoint (ecr.api, ecr.dkr) ãŒä½œæˆã•ã‚Œã‚‹
- [ ] CloudWatch Logs ç”¨ VPC Endpoint (logs) ãŒä½œæˆã•ã‚Œã‚‹
- [ ] S3 ç”¨ Gateway Endpoint ãŒä½œæˆã•ã‚Œã‚‹
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦æˆåŠŸã™ã‚‹

---

## ä¸»è¦å®Ÿè£…é …ç›®

### SSM VPC Endpoints ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¦ä»¶å®šç¾©æ›¸ REQ-008ã‚ˆã‚Š*

ECS Exec (SSM Session Manager) ã‚’ VPC å†…éƒ¨çµŒç”±ã§åˆ©ç”¨ã™ã‚‹ãŸã‚ã® Interface Endpoint ã‚’ä½œæˆã™ã‚‹ã€‚

```typescript
// SSM Endpoint
vpc.addInterfaceEndpoint('SsmEndpoint', {
  service: ec2.InterfaceVpcEndpointAwsService.SSM,
  subnets: { subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS },
});

// SSM Messages Endpoint
vpc.addInterfaceEndpoint('SsmMessagesEndpoint', {
  service: ec2.InterfaceVpcEndpointAwsService.SSM_MESSAGES,
  subnets: { subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS },
});

// EC2 Messages Endpoint
vpc.addInterfaceEndpoint('Ec2MessagesEndpoint', {
  service: ec2.InterfaceVpcEndpointAwsService.EC2_MESSAGES,
  subnets: { subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS },
});
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/vpc/endpoints-construct.ts`

---

### ECR VPC Endpoints ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¦ä»¶å®šç¾©æ›¸ REQ-009ã‚ˆã‚Š*

ECS Fargate ãŒ ECR ã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ Pull ã™ã‚‹ãŸã‚ã® Interface Endpoint ã‚’ä½œæˆã™ã‚‹ã€‚

```typescript
// ECR API Endpoint
vpc.addInterfaceEndpoint('EcrApiEndpoint', {
  service: ec2.InterfaceVpcEndpointAwsService.ECR,
  subnets: { subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS },
});

// ECR Docker Endpoint
vpc.addInterfaceEndpoint('EcrDkrEndpoint', {
  service: ec2.InterfaceVpcEndpointAwsService.ECR_DOCKER,
  subnets: { subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS },
});
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/vpc/endpoints-construct.ts`

---

### CloudWatch Logs VPC Endpoint ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¦ä»¶å®šç¾©æ›¸ REQ-010ã‚ˆã‚Š*

ECS ã‚¿ã‚¹ã‚¯ã‹ã‚‰ã®ãƒ­ã‚°é€ä¿¡ã‚’ VPC å†…éƒ¨çµŒç”±ã§è¡Œã†ãŸã‚ã® Interface Endpoint ã‚’ä½œæˆã™ã‚‹ã€‚

```typescript
vpc.addInterfaceEndpoint('CloudWatchLogsEndpoint', {
  service: ec2.InterfaceVpcEndpointAwsService.CLOUDWATCH_LOGS,
  subnets: { subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS },
});
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/vpc/endpoints-construct.ts`

---

### S3 Gateway Endpoint ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¦ä»¶å®šç¾©æ›¸ REQ-011ã‚ˆã‚Š*

ECR ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å–å¾—ãŠã‚ˆã³ S3 ã‚¢ã‚¯ã‚»ã‚¹ã®ãŸã‚ã® Gateway Endpoint ã‚’ä½œæˆã™ã‚‹ã€‚Gateway Endpoint ã¯ã‚³ã‚¹ãƒˆãŒç™ºç”Ÿã—ãªã„ãŸã‚ã€ã‚³ã‚¹ãƒˆæœ€é©åŒ–ã«è²¢çŒ®ã™ã‚‹ã€‚

```typescript
vpc.addGatewayEndpoint('S3Endpoint', {
  service: ec2.GatewayVpcEndpointAwsService.S3,
  subnets: [
    { subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS },
    { subnetType: ec2.SubnetType.PRIVATE_ISOLATED },
  ],
});
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/vpc/endpoints-construct.ts`

---

## åŸºæœ¬çš„ãªãƒ†ã‚¹ãƒˆè¦ä»¶

### SSM Endpoints ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¦ä»¶å®šç¾©æ›¸ REQ-008ã‚ˆã‚Š*

- ssm Interface Endpoint ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- ssmmessages Interface Endpoint ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- ec2messages Interface Endpoint ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- å„ Endpoint ãŒ Private App Subnet ã«é…ç½®ã•ã‚Œã¦ã„ã‚‹ã“ã¨

### ECR Endpoints ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¦ä»¶å®šç¾©æ›¸ REQ-009ã‚ˆã‚Š*

- ecr.api Interface Endpoint ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- ecr.dkr Interface Endpoint ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- å„ Endpoint ãŒ Private App Subnet ã«é…ç½®ã•ã‚Œã¦ã„ã‚‹ã“ã¨

### CloudWatch Logs Endpoint ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¦ä»¶å®šç¾©æ›¸ REQ-010ã‚ˆã‚Š*

- logs Interface Endpoint ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- Endpoint ãŒ Private App Subnet ã«é…ç½®ã•ã‚Œã¦ã„ã‚‹ã“ã¨

### S3 Gateway Endpoint ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¦ä»¶å®šç¾©æ›¸ REQ-011ã‚ˆã‚Š*

- S3 Gateway Endpoint ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- Route Table ã« S3 ã¸ã®ãƒ«ãƒ¼ãƒˆãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨

---

## å®Ÿè£…æ‰‹é †

### TDDã‚¿ã‚¹ã‚¯ã®å ´åˆ

1. `/tsumiki:tdd-requirements TASK-0003` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 8é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 8é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
