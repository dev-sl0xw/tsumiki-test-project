# TASK-0021: CloudWatch Logs 設定 ✅ **完了** (TDD開発完了 - 31テストケース全通過)

**タスクID**: TASK-0021
**タスクタイプ**: TDD
**推定工数**: 4時間
**フェーズ**: Phase 4 - 配信・運用
**信頼性レベル**: 🔵 *要件定義書 REQ-035〜038, REQ-101, REQ-102より*
**完了日**: 2026-02-04

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/aws-cdk-serverless-architecture/requirements.md) - REQ-035, REQ-036, REQ-037, REQ-038, REQ-101, REQ-102
- **設計文書**: [📐 architecture.md](../../design/aws-cdk-serverless-architecture/architecture.md)

## タスク概要

CloudWatch Logs の Log Groups を作成し、環境別の Retention 設定を行う。Dev 環境では短期間 (1-3日) の保持、Prod 環境では長期間 (15-30日) の保持と S3 Glacier への Export 設定を実装する。

## 依存タスク

- **前提タスク**: [TASK-0020](TASK-0020.md) - Distribution Stack 統合
- **後続タスク**: [TASK-0022](TASK-0022.md) - CloudWatch Alarms + Chatbot 設定

## 完了条件

- [x] ECS、RDS、VPC Flow Log 用の Log Groups が作成される
- [x] Dev 環境で 3 日間のログ保持期間が設定される
- [x] Prod 環境で 30 日間のログ保持期間が設定される
- [x] Prod 環境で S3 Glacier への Export 設定が構成される
- [x] 環境別パラメータによる動的設定が可能である
- [x] 全てのユニットテストが通過する

---

## 主要実装項目

### Log Groups 作成 🔵

**信頼性**: 🔵 *要件定義書 REQ-035より*

ECS、RDS、VPC Flow Logs 用の Log Groups を作成する。

**Log Groups**:
- `/ecs/{env-name}/frontend` - Frontend ECS Service ログ
- `/ecs/{env-name}/backend` - Backend ECS Service ログ
- `/rds/{env-name}/aurora` - Aurora MySQL ログ
- `/vpc/{env-name}/flow-logs` - VPC Flow Logs

**実装ファイル**: `lib/construct/monitoring/log-group-construct.ts`

### 環境別 Retention 設定 🔵

**信頼性**: 🔵 *要件定義書 REQ-036, REQ-037, REQ-102より*

環境に応じたログ保持期間を設定する。

**設定値**:
- Dev 環境: `RetentionDays.THREE_DAYS` (3日)
- Prod 環境: `RetentionDays.ONE_MONTH` (30日)

**実装ファイル**: `lib/construct/monitoring/log-group-construct.ts`

### S3 Glacier Export 設定 (Prod) 🔵

**信頼性**: 🔵 *要件定義書 REQ-038, REQ-101より*

Prod 環境でログを S3 Glacier に長期保存する設定を構成する。

**設定内容**:
- Kinesis Data Firehose または CloudWatch Logs Subscription Filter による S3 Export
- S3 Lifecycle Rule で Glacier への移行 (30日後)
- または Lambda 関数による定期 Export

**実装ファイル**: `lib/construct/monitoring/log-export-construct.ts`

### Log Group 暗号化設定 🔵

**信頼性**: 🔵 *セキュリティベストプラクティスより*

KMS キーによる Log Group の暗号化を設定する。

**設定内容**:
- KMS Customer Managed Key 作成
- Log Group の encryptionKey 設定

**実装ファイル**: `lib/construct/monitoring/log-group-construct.ts`

---

## 基本的なテスト要件

### Log Groups 作成テスト 🔵

**信頼性**: 🔵 *要件定義書 REQ-035より*

- 必要な Log Groups が全て作成されること
- 命名規則が正しく適用されること

### Retention 設定テスト 🔵

**信頼性**: 🔵 *要件定義書 REQ-036, REQ-037より*

- Dev 環境で 3 日間の保持期間が設定されること
- Prod 環境で 30 日間の保持期間が設定されること
- 環境パラメータによる動的設定が機能すること

### S3 Glacier Export テスト 🔵

**信頼性**: 🔵 *要件定義書 REQ-038, REQ-101より*

- Prod 環境で S3 Export 設定が構成されること
- S3 Lifecycle Rule が正しく設定されること

### 暗号化テスト 🔵

**信頼性**: 🔵 *セキュリティベストプラクティスより*

- Log Groups が暗号化されること
- KMS キーが正しく設定されること

---

## 実装手順

### TDDタスクの場合

1. `/tsumiki:tdd-requirements TASK-0021` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 信頼性レベルサマリー

- **総項目数**: 8項目
- 🔵 **青信号**: 8項目 (100%)
- 🟡 **黄信号**: 0項目 (0%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 高品質 - 全ての項目が要件定義書により確認済み
