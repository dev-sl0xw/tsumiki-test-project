# TASK-0011: WAF Construct å®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0011
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 6æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 2 - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¦ä»¶å®šç¾©æ›¸ã«åŸºã¥ã*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](overview.md)
- **è¦ä»¶å®šç¾©**: [ğŸ“‹ requirements.md](../../spec/aws-cdk-serverless-architecture/requirements.md) - REQ-033, REQ-034
- **è¨­è¨ˆæ–‡æ›¸**: [ğŸ“ architecture.md](../../design/aws-cdk-serverless-architecture/architecture.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

AWS WAF WebACL ã‚’æ§‹ç¯‰ã™ã‚‹ CDK Construct ã‚’å®Ÿè£…ã—ã¾ã™ã€‚AWS Managed Rulesï¼ˆCommon Rule Setã€SQL Injectionï¼‰ã®é©ç”¨ã€ALB ã¨ã®é–¢é€£ä»˜ã‘ã€ãƒ­ã‚°è¨­å®šã‚’å«ã‚€ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚°ãƒ¬ãƒ¼ãƒ‰ã® Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã‚’æ§‹æˆã—ã¾ã™ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: [TASK-0007](TASK-0007.md) Security Stack çµ±åˆ
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: Phase 3 - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã‚¿ã‚¹ã‚¯ï¼ˆALB ã¨ã®çµ±åˆï¼‰

## å®Œäº†æ¡ä»¶ âœ… **å®Œäº†** (TDDé–‹ç™ºå®Œäº† - 30ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å…¨é€šé)

- [x] WAF WebACL ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã‚‹
- [x] AWS Managed Rules - Common Rule Set ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹
- [x] AWS Managed Rules - SQL Injection ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹
- [x] CloudWatch Logs ã¸ã®ãƒ­ã‚°å‡ºåŠ›ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [x] ALB ã¨ã®é–¢é€£ä»˜ã‘ãŒå¯èƒ½ãªè¨­è¨ˆã«ãªã£ã¦ã„ã‚‹
- [x] ã™ã¹ã¦ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒé€šéã—ã¦ã„ã‚‹

---

## ä¸»è¦å®Ÿè£…é …ç›®

### WAF WebACL æ§‹æˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *REQ-033*

WAF WebACL ã®åŸºæœ¬æ§‹æˆã‚’å®Ÿè£…ã—ã¾ã™ã€‚ãƒªãƒ¼ã‚¸ãƒ§ãƒŠãƒ« WebACLï¼ˆALB ç”¨ï¼‰ã®ä½œæˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨­å®šã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨­å®šã‚’å«ã¿ã¾ã™ã€‚

```typescript
export interface WafConstructProps {
  envName: string;
  scope: 'REGIONAL' | 'CLOUDFRONT';
  enableLogging?: boolean;  // default: true
}

export class WafConstruct extends Construct {
  public readonly webAcl: wafv2.CfnWebACL;
  public readonly webAclArn: string;
}
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/waf-construct.ts`

### AWS Managed Rules - Common Rule Set ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *REQ-034*

AWSManagedRulesCommonRuleSet ã®é©ç”¨ã€‚ä¸€èˆ¬çš„ãªè„†å¼±æ€§ï¼ˆXSSã€LFIã€RFI ãªã©ï¼‰ã‹ã‚‰ã®ä¿è­·ã‚’æä¾›ã—ã¾ã™ã€‚

```typescript
{
  name: 'AWSManagedRulesCommonRuleSet',
  priority: 1,
  overrideAction: { none: {} },
  statement: {
    managedRuleGroupStatement: {
      vendorName: 'AWS',
      name: 'AWSManagedRulesCommonRuleSet',
    },
  },
  visibilityConfig: {
    sampledRequestsEnabled: true,
    cloudWatchMetricsEnabled: true,
    metricName: 'AWSManagedRulesCommonRuleSetMetric',
  },
}
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/waf-construct.ts`

### AWS Managed Rules - SQL Injection ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *REQ-034*

AWSManagedRulesSQLiRuleSet ã®é©ç”¨ã€‚SQL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒã‹ã‚‰ã®ä¿è­·ã‚’æä¾›ã—ã¾ã™ã€‚

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/waf-construct.ts`

### ãƒ­ã‚°è¨­å®š ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *é‹ç”¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹*

CloudWatch Logs ã¸ã®ãƒ­ã‚°å‡ºåŠ›è¨­å®šã€‚WAF ãƒ­ã‚°ç”¨ãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆã€ãƒ­ã‚°ä¿æŒæœŸé–“è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ30æ—¥ï¼‰ã‚’å«ã¿ã¾ã™ã€‚

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/waf-construct.ts`

### ALB é–¢é€£ä»˜ã‘æ©Ÿèƒ½ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *CDK ãƒ‘ã‚¿ãƒ¼ãƒ³*

WebACL ã¨ ALB ã‚’é–¢é€£ä»˜ã‘ã‚‹ãŸã‚ã® WebACLAssociationã€‚ALB ARN ã‚’å—ã‘å–ã‚Šã€WAF ã‚’é©ç”¨ã™ã‚‹æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚

```typescript
public associateWithAlb(albArn: string): void {
  new wafv2.CfnWebACLAssociation(this, 'WebACLAssociation', {
    resourceArn: albArn,
    webAclArn: this.webAcl.attrArn,
  });
}
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/waf-construct.ts`

---

## åŸºæœ¬çš„ãªãƒ†ã‚¹ãƒˆè¦ä»¶

### WebACL ä½œæˆãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *CDK ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³*

- WAF WebACL ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã‚‹ã“ã¨
- ã‚¹ã‚³ãƒ¼ãƒ—ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ï¼ˆREGIONALï¼‰
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨

### Managed Rules ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *REQ-033, REQ-034 ã«åŸºã¥ã*

- AWSManagedRulesCommonRuleSet ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨
- AWSManagedRulesSQLiRuleSet ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨
- ãƒ«ãƒ¼ãƒ«ã®å„ªå…ˆåº¦ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨

### ãƒ­ã‚°è¨­å®šãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *é‹ç”¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹*

- CloudWatch Logs ãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ãŒä½œæˆã•ã‚Œã‚‹ã“ã¨
- ãƒ­ã‚°ä¿æŒæœŸé–“ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨

### ALB é–¢é€£ä»˜ã‘ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *CDK ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³*

- WebACLAssociation ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆå¯èƒ½ã§ã‚ã‚‹ã“ã¨
- æ­£ã—ã„ ARN ãŒå‚ç…§ã•ã‚Œã¦ã„ã‚‹ã“ã¨

---

## å®Ÿè£…æ‰‹é †

### TDDã‚¿ã‚¹ã‚¯ã®å ´åˆ

1. `/tsumiki:tdd-requirements TASK-0011` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 9é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 9é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
