# TASK-0014: Task Definition Construct å®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0014
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 8æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3 - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¦ä»¶å®šç¾©æ›¸ãƒ»è¨­è¨ˆæ–‡æ›¸ã‚ˆã‚Š*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](overview.md)
- **è¦ä»¶å®šç¾©**: [ğŸ“‹ requirements.md](../../spec/aws-cdk-serverless-architecture/requirements.md) - REQ-014, REQ-015, REQ-016, REQ-017, REQ-018
- **è¨­è¨ˆæ–‡æ›¸**: [ğŸ“ architecture.md](../../design/aws-cdk-serverless-architecture/architecture.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ECS Fargate ç”¨ã® Task Definition Construct ã‚’å®Ÿè£…ã—ã¾ã™ã€‚App Container ã¨ Sidecar Container ã®ãƒãƒ«ãƒã‚³ãƒ³ãƒ†ãƒŠæ§‹æˆã§ã€0.5vCPU/1GB ãƒ¡ãƒ¢ãƒªã®è¨­å®šã¨é©åˆ‡ãª Task Role ã‚’ä»˜ä¸ã—ã¾ã™ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: [TASK-0012](TASK-0012.md) - ECS Cluster Construct å®Ÿè£…, [TASK-0013](TASK-0013.md) - Sidecar Container ã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆ
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: [TASK-0015](TASK-0015.md) - ECS Service Construct å®Ÿè£…

## å®Œäº†æ¡ä»¶

- [ ] Task Definition Construct ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã‚‹ã“ã¨
- [ ] App Container ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨
- [ ] Sidecar Container ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨
- [ ] CPU/ãƒ¡ãƒ¢ãƒªãŒ 0.5vCPU/1GB ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨
- [ ] Task Role ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨
- [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦ãƒ‘ã‚¹ã™ã‚‹ã“ã¨
- [ ] ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹ã“ã¨

---

## ä¸»è¦å®Ÿè£…é …ç›®

### Fargate Task Definition ä½œæˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *REQ-014 ã‚ˆã‚Š*

Fargate äº’æ›ã® Task Definition ã‚’ä½œæˆã—ã¾ã™ã€‚CPU ã¨ãƒ¡ãƒ¢ãƒªã®çµ„ã¿åˆã‚ã›ã¯ Fargate ã®åˆ¶ç´„ã«å¾“ã„ã¾ã™ã€‚

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/task-definition-construct.ts`

```typescript
import * as ecs from 'aws-cdk-lib/aws-ecs';

const taskDefinition = new ecs.FargateTaskDefinition(this, 'TaskDef', {
  memoryLimitMiB: 1024,
  cpu: 512,
  taskRole: taskRole,
  executionRole: executionRole,
});
```

### App Container è¨­å®š ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *REQ-015 ã‚ˆã‚Š*

ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã‚’è¨­å®šã—ã¾ã™ã€‚ãƒ­ã‚°è¨­å®šã€ç’°å¢ƒå¤‰æ•°ã€ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å«ã¿ã¾ã™ã€‚

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/task-definition-construct.ts`

```typescript
const appContainer = taskDefinition.addContainer('app', {
  image: ecs.ContainerImage.fromEcrRepository(props.appRepository),
  logging: ecs.LogDrivers.awsLogs({
    streamPrefix: 'app',
    logGroup: props.logGroup,
  }),
  portMappings: [{ containerPort: 3000 }],
  environment: props.environment,
  essential: true,
});
```

### Sidecar Container è¨­å®š ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *REQ-016 ã‚ˆã‚Š*

Service Connect ç”¨ã® Sidecar Container ã‚’è¨­å®šã—ã¾ã™ã€‚App Container ã¨ã®ä¾å­˜é–¢ä¿‚ã‚’è¨­å®šã—ã¾ã™ã€‚

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/task-definition-construct.ts`

```typescript
const sidecarContainer = taskDefinition.addContainer('sidecar', {
  image: ecs.ContainerImage.fromEcrRepository(props.sidecarRepository),
  logging: ecs.LogDrivers.awsLogs({
    streamPrefix: 'sidecar',
    logGroup: props.logGroup,
  }),
  essential: false,
});

sidecarContainer.addContainerDependencies({
  container: appContainer,
  condition: ecs.ContainerDependencyCondition.START,
});
```

### Task Role è¨­å®š ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *REQ-017, REQ-018 ã‚ˆã‚Š*

Task Role ã«å¿…è¦æœ€å°é™ã®æ¨©é™ã‚’ä»˜ä¸ã—ã¾ã™ã€‚Secrets Manager ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã€CloudWatch Logs ã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’å«ã¿ã¾ã™ã€‚

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/task-definition-construct.ts`

```typescript
const taskRole = new iam.Role(this, 'TaskRole', {
  assumedBy: new iam.ServicePrincipal('ecs-tasks.amazonaws.com'),
});

taskRole.addToPolicy(new iam.PolicyStatement({
  actions: ['secretsmanager:GetSecretValue'],
  resources: [props.secretArn],
}));
```

---

## åŸºæœ¬çš„ãªãƒ†ã‚¹ãƒˆè¦ä»¶

### Task Definition ä½œæˆãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *REQ-014 ã‚ˆã‚Š*

- FargateTaskDefinition ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã‚‹ã“ã¨
- CPU ãŒ 512 (0.5vCPU) ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨
- ãƒ¡ãƒ¢ãƒªãŒ 1024MB (1GB) ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨

### Container è¨­å®šãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *REQ-015, REQ-016 ã‚ˆã‚Š*

- App Container ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨
- Sidecar Container ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨
- ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨
- ãƒ­ã‚°è¨­å®šãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨

### Task Role ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *REQ-017, REQ-018 ã‚ˆã‚Š*

- Task Role ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- å¿…è¦ãªæ¨©é™ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹ã“ã¨
- æœ€å°æ¨©é™ã®åŸå‰‡ã«å¾“ã£ã¦ã„ã‚‹ã“ã¨

### ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¨­è¨ˆæ–‡æ›¸ã‚ˆã‚Š*

- CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæœŸå¾…é€šã‚Šã«ç”Ÿæˆã•ã‚Œã‚‹ã“ã¨

---

## å®Ÿè£…æ‰‹é †

### TDDã‚¿ã‚¹ã‚¯ã®å ´åˆ

1. `/tsumiki:tdd-requirements TASK-0014` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 8é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 8é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
