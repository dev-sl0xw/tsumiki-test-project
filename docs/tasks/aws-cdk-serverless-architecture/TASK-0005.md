# TASK-0005: Security Group Construct å®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0005
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 6æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 1 - åŸºç›¤æ§‹ç¯‰
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¦ä»¶å®šç¾©æ›¸ãƒ»è¨­è¨ˆæ–‡æ›¸ã‚ˆã‚Š*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](overview.md)
- **è¦ä»¶å®šç¾©**: [ğŸ“‹ requirements.md](../../spec/aws-cdk-serverless-architecture/requirements.md) - REQ-024, REQ-025
- **è¨­è¨ˆæ–‡æ›¸**: [ğŸ“ architecture.md](../../design/aws-cdk-serverless-architecture/architecture.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¿…è¦ãª Security Group ã‚’å®šç¾©ã™ã‚‹ Construct ã‚’ä½œæˆã™ã‚‹ã€‚ALBã€ECS Fargateã€Aurora ç”¨ã® Security Group ã‚’ä½œæˆã—ã€æœ€å°æ¨©é™ã®åŸå‰‡ã«å¾“ã£ãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã™ã‚‹ã€‚ç‰¹ã« Aurora ã¸ã®å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹é®æ–­ã¨ ECS ã‹ã‚‰ã® 3306 ãƒãƒ¼ãƒˆã‚¢ã‚¯ã‚»ã‚¹ã®ã¿è¨±å¯ã‚’å®Ÿè£…ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: [TASK-0004](TASK-0004.md) (VPC Stack çµ±åˆ)
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: Phase 2 - Application Stack

## å®Œäº†æ¡ä»¶

- [ ] SecurityGroupConstruct ã‚¯ãƒ©ã‚¹ãŒ lib/construct/security/security-group-construct.ts ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] ALB ç”¨ Security Group ãŒä½œæˆã•ã‚Œã€HTTP(80)/HTTPS(443) ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹
- [ ] ECS ç”¨ Security Group ãŒä½œæˆã•ã‚Œã€ALB ã‹ã‚‰ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®ã¿è¨±å¯ã•ã‚Œã¦ã„ã‚‹
- [ ] Aurora ç”¨ Security Group ãŒä½œæˆã•ã‚Œã€ECS Security Group ã‹ã‚‰ã® 3306 ã®ã¿è¨±å¯ã•ã‚Œã¦ã„ã‚‹
- [ ] Aurora Security Group ã§å¤–éƒ¨ã‹ã‚‰ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ãŒé®æ–­ã•ã‚Œã¦ã„ã‚‹
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦æˆåŠŸã™ã‚‹

---

## ä¸»è¦å®Ÿè£…é …ç›®

### ALB Security Group ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¨­è¨ˆæ–‡æ›¸ãƒ»ALB è¦ä»¶ã‚ˆã‚Š*

Internet-facing ALB ç”¨ã® Security Group ã‚’ä½œæˆã™ã‚‹ã€‚HTTP(80) ã¨ HTTPS(443) ã®ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’è¨±å¯ã™ã‚‹ã€‚

```typescript
const albSg = new ec2.SecurityGroup(this, 'AlbSecurityGroup', {
  vpc,
  description: 'Security group for Application Load Balancer',
  allowAllOutbound: true,
});

albSg.addIngressRule(
  ec2.Peer.anyIpv4(),
  ec2.Port.tcp(80),
  'Allow HTTP from anywhere'
);

albSg.addIngressRule(
  ec2.Peer.anyIpv4(),
  ec2.Port.tcp(443),
  'Allow HTTPS from anywhere'
);
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/security/security-group-construct.ts`

---

### ECS Security Group ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¨­è¨ˆæ–‡æ›¸ãƒ»ECS è¦ä»¶ã‚ˆã‚Š*

ECS Fargate ã‚¿ã‚¹ã‚¯ç”¨ã® Security Group ã‚’ä½œæˆã™ã‚‹ã€‚ALB ã‹ã‚‰ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®ã¿ã‚’è¨±å¯ã™ã‚‹ã€‚

```typescript
const ecsSg = new ec2.SecurityGroup(this, 'EcsSecurityGroup', {
  vpc,
  description: 'Security group for ECS Fargate tasks',
  allowAllOutbound: true,
});

ecsSg.addIngressRule(
  albSg,
  ec2.Port.tcp(containerPort),
  'Allow traffic from ALB'
);
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/security/security-group-construct.ts`

---

### Aurora Security Group ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¦ä»¶å®šç¾©æ›¸ REQ-024, REQ-025ã‚ˆã‚Š*

Aurora ç”¨ã® Security Group ã‚’ä½œæˆã™ã‚‹ã€‚å¤–éƒ¨ã‹ã‚‰ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã‚’é®æ–­ã—ã€ECS Security Group ã‹ã‚‰ã® 3306 ãƒãƒ¼ãƒˆã‚¢ã‚¯ã‚»ã‚¹ã®ã¿ã‚’è¨±å¯ã™ã‚‹ã€‚

```typescript
const auroraSg = new ec2.SecurityGroup(this, 'AuroraSecurityGroup', {
  vpc,
  description: 'Security group for Aurora MySQL',
  allowAllOutbound: false, // å¤–å‘ããƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚‚åˆ¶é™
});

// ECS ã‹ã‚‰ã® MySQL æ¥ç¶šã®ã¿è¨±å¯
auroraSg.addIngressRule(
  ecsSg,
  ec2.Port.tcp(3306),
  'Allow MySQL from ECS tasks only'
);
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/security/security-group-construct.ts`

---

### æœ€å°æ¨©é™ã®åŸå‰‡é©ç”¨ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚ˆã‚Š*

å„ Security Group ã§å¿…è¦æœ€å°é™ã®ãƒ«ãƒ¼ãƒ«ã®ã¿ã‚’å®šç¾©ã™ã‚‹ã€‚

| Security Group | ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ | ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ |
|----------------|-------------|---------------|
| ALB SG | 0.0.0.0/0:80, 0.0.0.0/0:443 | All |
| ECS SG | ALB SG:containerPort | All |
| Aurora SG | ECS SG:3306 | ãªã— |

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/construct/security/security-group-construct.ts`

---

## åŸºæœ¬çš„ãªãƒ†ã‚¹ãƒˆè¦ä»¶

### ALB Security Group ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¨­è¨ˆæ–‡æ›¸ã‚ˆã‚Š*

- ALB Security Group ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- HTTP(80) ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãŒ 0.0.0.0/0 ã‹ã‚‰è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã“ã¨
- HTTPS(443) ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãŒ 0.0.0.0/0 ã‹ã‚‰è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã“ã¨

### ECS Security Group ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¨­è¨ˆæ–‡æ›¸ã‚ˆã‚Š*

- ECS Security Group ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- ALB Security Group ã‹ã‚‰ã®ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ã®ã¿è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã“ã¨
- å¤–éƒ¨ã‹ã‚‰ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ãªã„ã“ã¨

### Aurora Security Group ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¦ä»¶å®šç¾©æ›¸ REQ-024, REQ-025ã‚ˆã‚Š*

- Aurora Security Group ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- ECS Security Group ã‹ã‚‰ã® 3306 ãƒãƒ¼ãƒˆã‚¢ã‚¯ã‚»ã‚¹ã®ã¿è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã“ã¨
- 0.0.0.0/0 ã‹ã‚‰ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ãªã„ã“ã¨
- ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹ã“ã¨

### æœ€å°æ¨©é™ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚ˆã‚Š*

- å„ Security Group ã«ä¸è¦ãªãƒ«ãƒ¼ãƒ«ãŒå«ã¾ã‚Œã¦ã„ãªã„ã“ã¨
- Security Group é–“ã®å‚ç…§é–¢ä¿‚ãŒæ­£ã—ã„ã“ã¨

---

## å®Ÿè£…æ‰‹é †

### TDDã‚¿ã‚¹ã‚¯ã®å ´åˆ

1. `/tsumiki:tdd-requirements TASK-0005` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 8é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 8é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
