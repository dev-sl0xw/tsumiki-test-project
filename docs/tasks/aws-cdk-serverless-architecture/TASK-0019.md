# TASK-0019: CloudFront Construct 実装

**タスクID**: TASK-0019
**タスクタイプ**: TDD
**推定工数**: 6時間
**フェーズ**: Phase 4 - 配信・運用
**信頼性レベル**: 🔵 *要件定義書 REQ-032, REQ-043より*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/aws-cdk-serverless-architecture/requirements.md) - REQ-032, REQ-043
- **設計文書**: [📐 architecture.md](../../design/aws-cdk-serverless-architecture/architecture.md)

## タスク概要

CloudFront Distribution を実装し、S3 Origin (OAC 経由) と ALB Origin を構成する。カスタムドメインは使用せず、CloudFront/ALB のデフォルトドメインを使用する。高性能なコンテンツ配信とキャッシング機能を提供する。

## 依存タスク

- **前提タスク**:
  - [TASK-0018](TASK-0018.md) - S3 + OAC Construct 実装
  - [TASK-0011](TASK-0011.md) - ALB Construct 実装
- **後続タスク**: [TASK-0020](TASK-0020.md) - Distribution Stack 統合

## 完了条件

- [ ] CloudFront Distribution が作成される
- [ ] S3 Origin が OAC 経由で設定される
- [ ] ALB Origin が設定される
- [ ] デフォルトドメインが使用可能である
- [ ] Viewer Protocol が HTTPS Only に設定される
- [ ] 適切な Cache Policy が設定される
- [ ] 全てのユニットテストが通過する

---

## 主要実装項目

### CloudFront Distribution 作成 🔵

**信頼性**: 🔵 *要件定義書 REQ-032, REQ-043・設計文書より*

コンテンツ配信のための CloudFront Distribution を作成する。

**設定項目**:
- `priceClass`: `PriceClass.PRICE_CLASS_200` (日本を含むリージョン)
- `defaultRootObject`: `index.html`
- `viewerProtocolPolicy`: `ViewerProtocolPolicy.REDIRECT_TO_HTTPS`
- `httpVersion`: `HttpVersion.HTTP2_AND_3`

**実装ファイル**: `lib/construct/distribution/cloudfront-construct.ts`

### S3 Origin (OAC) 設定 🔵

**信頼性**: 🔵 *要件定義書 REQ-032より*

静的コンテンツ用の S3 Origin を OAC 経由で構成する。

**設定項目**:
- Origin: S3 バケット (TASK-0018 で作成)
- OAC: Origin Access Control 使用
- Behavior: 静的アセットパス (`/static/*`, `/assets/*` など)

**実装ファイル**: `lib/construct/distribution/cloudfront-construct.ts`

### ALB Origin 設定 🔵

**信頼性**: 🔵 *設計文書より*

動的コンテンツ用の ALB Origin を構成する。

**設定項目**:
- Origin: ALB (TASK-0011 で作成)
- Protocol: HTTPS
- Behavior: API パス (`/api/*`) およびデフォルト

**実装ファイル**: `lib/construct/distribution/cloudfront-construct.ts`

### Cache Policy 設定 🔵

**信頼性**: 🔵 *CDK ベストプラクティスより*

Origin タイプに応じた適切なキャッシュポリシーを設定する。

**設定項目**:
- S3 Origin: `CachePolicy.CACHING_OPTIMIZED`
- ALB Origin: `CachePolicy.CACHING_DISABLED` または適切な TTL 設定

**実装ファイル**: `lib/construct/distribution/cloudfront-construct.ts`

### エラーページ設定 🔵

**信頼性**: 🔵 *要件定義書 REQ-031より (Sorry Page)*

カスタムエラーレスポンス設定で Sorry Page を返却する。

**設定項目**:
- 4xx/5xx エラー時に S3 の Sorry Page を返却
- エラーキャッシュ TTL の設定

**実装ファイル**: `lib/construct/distribution/cloudfront-construct.ts`

---

## 基本的なテスト要件

### CloudFront Distribution 作成テスト 🔵

**信頼性**: 🔵 *要件定義書 REQ-032より*

- CloudFront Distribution リソースが作成されること
- Price Class が正しく設定されること
- Viewer Protocol Policy が REDIRECT_TO_HTTPS であること

### Origin 設定テスト 🔵

**信頼性**: 🔵 *要件定義書 REQ-032・設計文書より*

- S3 Origin が OAC 経由で設定されること
- ALB Origin が設定されること
- パスベースのルーティングが正しく設定されること

### Cache Policy テスト 🔵

**信頼性**: 🔵 *CDK ベストプラクティスより*

- S3 Origin に適切な Cache Policy が設定されること
- ALB Origin に適切な Cache Policy が設定されること

### エラーページテスト 🔵

**信頼性**: 🔵 *要件定義書 REQ-031より*

- カスタムエラーレスポンスが設定されること
- 適切なエラーページパスが指定されること

---

## 実装手順

### TDDタスクの場合

1. `/tsumiki:tdd-requirements TASK-0019` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 信頼性レベルサマリー

- **総項目数**: 9項目
- 🔵 **青信号**: 9項目 (100%)
- 🟡 **黄信号**: 0項目 (0%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 高品質 - 全ての項目が要件定義書・設計文書により確認済み
