# TASK-0022: CloudWatch Alarms + Chatbot 設定

**タスクID**: TASK-0022
**タスクタイプ**: TDD
**推定工数**: 6時間
**フェーズ**: Phase 4 - 配信・運用
**信頼性レベル**: 🔵 *要件定義書 REQ-039, REQ-103より*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/aws-cdk-serverless-architecture/requirements.md) - REQ-039, REQ-103
- **設計文書**: [📐 architecture.md](../../design/aws-cdk-serverless-architecture/architecture.md)

## タスク概要

CloudWatch Alarms を作成し、ECS の CPU/Memory 使用率およびログエラーパターンを監視する。アラーム発生時に SNS Topic 経由で AWS Chatbot に通知し、Slack チャンネルにアラートを送信する仕組みを構築する。

## 依存タスク

- **前提タスク**: [TASK-0021](TASK-0021.md) - CloudWatch Logs 設定
- **後続タスク**: [TASK-0024](TASK-0024.md) - Ops Stack 統合 + 最終統合テスト

## 完了条件

- [ ] ECS CPU Utilization Alarm が作成される (閾値: 80%)
- [ ] ECS Memory Utilization Alarm が作成される (閾値: 80%)
- [ ] CloudWatch Logs Error Pattern Alarm が作成される
- [ ] SNS Topic が作成される
- [ ] AWS Chatbot が Slack と連携される
- [ ] アラーム発生時に Slack 通知が送信される
- [ ] 全てのユニットテストが通過する

---

## 主要実装項目

### ECS CPU/Memory Alarms 🔵

**信頼性**: 🔵 *設計文書・ユーザヒアリングより*

ECS Service の CPU および Memory 使用率を監視する Alarm を作成する。

**設定項目**:
- メトリクス: `CPUUtilization`, `MemoryUtilization`
- 閾値: 80%
- 評価期間: 5 分
- 評価回数: 3 回連続
- アクション: SNS Topic への通知

**実装ファイル**: `lib/construct/monitoring/alarm-construct.ts`

### CloudWatch Logs Error Alarm 🔵

**信頼性**: 🔵 *設計文書・ユーザヒアリングより*

CloudWatch Logs のエラーパターンを検出する Metric Filter と Alarm を作成する。

**設定項目**:
- Metric Filter: エラーログパターン検出 (`ERROR`, `Exception` など)
- 閾値: 1 件以上
- 評価期間: 5 分
- アクション: SNS Topic への通知

**実装ファイル**: `lib/construct/monitoring/alarm-construct.ts`

### SNS Topic 作成 🔵

**信頼性**: 🔵 *要件定義書 REQ-039より*

アラーム通知用の SNS Topic を作成する。

**設定項目**:
- Topic 名: `{env-name}-alarm-notifications`
- 暗号化: KMS 有効

**実装ファイル**: `lib/construct/monitoring/notification-construct.ts`

### AWS Chatbot 設定 🔵

**信頼性**: 🔵 *要件定義書 REQ-039, REQ-103より*

AWS Chatbot を設定し、Slack ワークスペースとの連携を構成する。

**設定項目**:
- Slack Workspace ID: パラメータから取得
- Slack Channel ID: パラメータから取得
- SNS Topic Subscription: アラーム通知用 Topic を購読
- IAM Role: Chatbot 用の実行ロール

**実装ファイル**: `lib/construct/monitoring/chatbot-construct.ts`

### 通知フォーマット設定 🔵

**信頼性**: 🔵 *運用ベストプラクティスより*

Slack 通知のフォーマットと内容を設定する。

**通知内容**:
- アラーム名
- 現在の状態
- メトリクス値
- タイムスタンプ
- アクションリンク (CloudWatch コンソールへ)

**実装ファイル**: `lib/construct/monitoring/chatbot-construct.ts`

---

## 基本的なテスト要件

### ECS Alarm テスト 🔵

**信頼性**: 🔵 *設計文書より*

- CPU Utilization Alarm が作成されること
- Memory Utilization Alarm が作成されること
- 閾値が 80% に設定されること
- SNS Topic への通知アクションが設定されること

### Log Error Alarm テスト 🔵

**信頼性**: 🔵 *設計文書より*

- Metric Filter が作成されること
- エラーパターン検出 Alarm が作成されること
- SNS Topic への通知アクションが設定されること

### SNS Topic テスト 🔵

**信頼性**: 🔵 *要件定義書 REQ-039より*

- SNS Topic が作成されること
- 暗号化が有効であること

### Chatbot テスト 🔵

**信頼性**: 🔵 *要件定義書 REQ-039, REQ-103より*

- Chatbot リソースが作成されること
- Slack Workspace/Channel ID が設定されること
- SNS Topic を購読すること

---

## 実装手順

### TDDタスクの場合

1. `/tsumiki:tdd-requirements TASK-0022` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 信頼性レベルサマリー

- **総項目数**: 9項目
- 🔵 **青信号**: 9項目 (100%)
- 🟡 **黄信号**: 0項目 (0%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 高品質 - 全ての項目が要件定義書・設計文書により確認済み
