# TASK-0020: Distribution Stack 統合

**タスクID**: TASK-0020
**タスクタイプ**: TDD
**推定工数**: 4時間
**フェーズ**: Phase 4 - 配信・運用
**信頼性レベル**: 🔵 *要件定義書 REQ-031〜034, REQ-043・設計文書より*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/aws-cdk-serverless-architecture/requirements.md) - REQ-031, REQ-032, REQ-033, REQ-034, REQ-043
- **設計文書**: [📐 architecture.md](../../design/aws-cdk-serverless-architecture/architecture.md)

## タスク概要

S3 バケット、CloudFront Distribution、WAF を Distribution Stack に統合する。コンテンツ配信レイヤーを一つの Stack としてまとめ、他の Stack からの依存関係を適切に管理する。

## 依存タスク

- **前提タスク**:
  - [TASK-0018](TASK-0018.md) - S3 + OAC Construct 実装
  - [TASK-0019](TASK-0019.md) - CloudFront Construct 実装
- **後続タスク**: [TASK-0021](TASK-0021.md) - CloudWatch Logs 設定

## 完了条件

- [ ] Distribution Stack が作成される
- [ ] S3 Construct が Stack に統合される
- [ ] CloudFront Construct が Stack に統合される
- [ ] WAF が CloudFront に接続される
- [ ] 他の Stack からの依存リソース (ALB, Security Group) が正しく参照される
- [ ] Stack 間の依存関係が適切に設定される
- [ ] 全てのユニットテストが通過する

---

## 主要実装項目

### Distribution Stack 作成 🔵

**信頼性**: 🔵 *設計文書より*

コンテンツ配信関連リソースを統合する Stack を作成する。

**責務**:
- S3 バケット (静的コンテンツ + Sorry Page)
- CloudFront Distribution
- OAC 設定
- WAF との接続

**実装ファイル**: `lib/stack/distribution-stack.ts`

### Construct 統合 🔵

**信頼性**: 🔵 *設計文書より*

各 Construct を Stack に統合し、依存関係を設定する。

**統合順序**:
1. S3 Bucket Construct 作成
2. OAC 設定
3. CloudFront Construct 作成 (S3 + ALB Origin)
4. WAF を CloudFront に接続

**実装ファイル**: `lib/stack/distribution-stack.ts`

### Stack 間依存関係設定 🔵

**信頼性**: 🔵 *CDK ベストプラクティスより*

他の Stack からのリソース参照と依存関係を設定する。

**依存リソース**:
- Application Stack から ALB の参照
- Security Stack から WAF WebACL の参照
- Security Stack から Security Group の参照 (必要に応じて)

**実装ファイル**: `lib/stack/distribution-stack.ts`

### Output 設定 🔵

**信頼性**: 🔵 *CDK ベストプラクティスより*

他の Stack やデプロイ後に必要な情報を出力する。

**出力項目**:
- CloudFront Distribution Domain Name
- CloudFront Distribution ID
- S3 Bucket Name

**実装ファイル**: `lib/stack/distribution-stack.ts`

---

## 基本的なテスト要件

### Stack 作成テスト 🔵

**信頼性**: 🔵 *設計文書より*

- Distribution Stack が作成されること
- 必要なリソースが全て含まれること

### Construct 統合テスト 🔵

**信頼性**: 🔵 *設計文書より*

- S3 Bucket Construct が正しく統合されること
- CloudFront Construct が正しく統合されること
- WAF が CloudFront に接続されること

### 依存関係テスト 🔵

**信頼性**: 🔵 *CDK ベストプラクティスより*

- ALB への参照が正しく設定されること
- WAF WebACL への参照が正しく設定されること
- Stack 間の依存関係が正しく設定されること

### Output テスト 🔵

**信頼性**: 🔵 *CDK ベストプラクティスより*

- CloudFront Domain Name が出力されること
- 必要な情報が全て出力されること

---

## 実装手順

### TDDタスクの場合

1. `/tsumiki:tdd-requirements TASK-0020` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 信頼性レベルサマリー

- **総項目数**: 8項目
- 🔵 **青信号**: 8項目 (100%)
- 🟡 **黄信号**: 0項目 (0%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 高品質 - 全ての項目が要件定義書・設計文書により確認済み
