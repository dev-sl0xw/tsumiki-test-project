# TASK-0013: Sidecar Container イメージ作成 ✅ **完了** (直接作業完了 - イメージサイズ9.56MB)

**タスクID**: TASK-0013
**タスクタイプ**: DIRECT
**推定工数**: 4時間
**フェーズ**: Phase 3 - アプリケーション
**信頼性レベル**: 🔵 *要件定義書・設計文書より*
**完了日**: 2026-01-24

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/aws-cdk-serverless-architecture/requirements.md) - REQ-015, REQ-016, REQ-017
- **設計文書**: [📐 architecture.md](../../design/aws-cdk-serverless-architecture/architecture.md)

## タスク概要

ECS Service Connect 用の Sidecar Container イメージを作成します。Alpine Linux ベースで socat を使用したプロキシコンテナを構築し、ECR にプッシュします。

## 依存タスク

- **前提タスク**: [TASK-0012](TASK-0012.md) - ECS Cluster Construct 実装
- **後続タスク**: [TASK-0014](TASK-0014.md) - Task Definition Construct 実装

## 完了条件

- [x] Dockerfile が作成されていること
- [x] Alpine + socat ベースのイメージがビルドできること
- [ ] ECR リポジトリにイメージがプッシュされていること（デプロイ時に実行）
- [x] イメージサイズが最適化されていること（9.56MB < 50MB目標）
- [x] ヘルスチェックが正常に動作すること

---

## 主要実装項目

### Dockerfile 作成 🔵

**信頼性**: 🔵 *REQ-015 より*

Alpine Linux ベースで socat をインストールした軽量コンテナイメージを作成します。

**実装ファイル**: `docker/sidecar/Dockerfile`

```dockerfile
FROM alpine:3.19

RUN apk add --no-cache socat

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 8080

HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD nc -z localhost 8080 || exit 1

ENTRYPOINT ["/entrypoint.sh"]
```

### エントリポイントスクリプト作成 🔵

**信頼性**: 🔵 *REQ-016 より*

socat を使用してプロキシ機能を提供するエントリポイントスクリプトを作成します。

**実装ファイル**: `docker/sidecar/entrypoint.sh`

```bash
#!/bin/sh
exec socat TCP-LISTEN:8080,fork,reuseaddr TCP:${TARGET_HOST}:${TARGET_PORT}
```

### ECR リポジトリ作成とプッシュ 🔵

**信頼性**: 🔵 *REQ-017 より*

ECR リポジトリを作成し、ビルドしたイメージをプッシュします。イメージスキャンを有効化してセキュリティ脆弱性を検出します。

**実装ファイル**: `lib/construct/ecr-construct.ts`

---

## 基本的なテスト要件

### イメージビルドテスト 🔵

**信頼性**: 🔵 *REQ-015 より*

- Docker イメージが正常にビルドできること
- イメージサイズが50MB以下であること

### コンテナ起動テスト 🔵

**信頼性**: 🔵 *REQ-016 より*

- コンテナが正常に起動すること
- ヘルスチェックがパスすること

### ECR プッシュテスト 🔵

**信頼性**: 🔵 *REQ-017 より*

- ECR へのプッシュが成功すること
- イメージスキャン結果に CRITICAL 脆弱性がないこと

---

## 実装手順

### DIRECTタスクの場合

1. `/tsumiki:direct-setup` - 直接実装・設定
2. `/tsumiki:direct-verify` - 動作確認・品質確認

---

## 信頼性レベルサマリー

- **総項目数**: 6項目
- 🔵 **青信号**: 6項目 (100%)
- 🟡 **黄信号**: 0項目 (0%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 高品質
