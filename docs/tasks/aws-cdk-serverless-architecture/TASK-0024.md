# TASK-0024: Ops Stack 統合 + 最終統合テスト

**タスクID**: TASK-0024
**タスクタイプ**: TDD
**推定工数**: 8時間
**フェーズ**: Phase 4 - 配信・運用
**信頼性レベル**: 🔵 *要件定義書 REQ-035〜041, REQ-042より*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/aws-cdk-serverless-architecture/requirements.md) - REQ-035, REQ-036, REQ-037, REQ-038, REQ-039, REQ-040, REQ-041, REQ-042
- **設計文書**: [📐 architecture.md](../../design/aws-cdk-serverless-architecture/architecture.md)

## タスク概要

CloudWatch Logs/Alarms、AWS Chatbot、CI/CD Pipeline を Ops Stack に統合する。また、全 6 Stack (VPC, Security, Database, Application, Distribution, Ops) の統合テストを実施し、Dev 環境と Prod 環境の設定差異が正しく反映されることを確認する。

## 依存タスク

- **前提タスク**:
  - [TASK-0021](TASK-0021.md) - CloudWatch Logs 設定
  - [TASK-0022](TASK-0022.md) - CloudWatch Alarms + Chatbot 設定
  - [TASK-0023](TASK-0023.md) - CI/CD Pipeline 構築
- **後続タスク**: なし (Phase 4 最終タスク)

## 完了条件

- [ ] Ops Stack が作成される
- [ ] CloudWatch Logs Construct が Stack に統合される
- [ ] CloudWatch Alarms Construct が Stack に統合される
- [ ] AWS Chatbot Construct が Stack に統合される
- [ ] CI/CD Pipeline Construct が Stack に統合される
- [ ] 全 6 Stack の統合テストが通過する
- [ ] Dev 環境設定が正しく適用される
- [ ] Prod 環境設定が正しく適用される
- [ ] CDK Synth が成功する
- [ ] 全てのユニットテストが通過する

---

## 主要実装項目

### Ops Stack 作成 🔵

**信頼性**: 🔵 *設計文書より*

運用・監視関連リソースを統合する Stack を作成する。

**責務**:
- CloudWatch Logs (Log Groups, Retention, Export)
- CloudWatch Alarms (ECS, Logs)
- SNS Topics (通知用)
- AWS Chatbot (Slack 連携)
- CI/CD Pipeline (CodeCommit, CodeBuild, CodePipeline)

**実装ファイル**: `lib/stack/ops-stack.ts`

### Construct 統合 🔵

**信頼性**: 🔵 *設計文書より*

各 Construct を Stack に統合し、依存関係を設定する。

**統合順序**:
1. Log Group Construct 作成
2. SNS Topic Construct 作成
3. Alarm Construct 作成 (Log Group, SNS 依存)
4. Chatbot Construct 作成 (SNS 依存)
5. CI/CD Pipeline Construct 作成

**実装ファイル**: `lib/stack/ops-stack.ts`

### Stack 間依存関係設定 🔵

**信頼性**: 🔵 *CDK ベストプラクティスより*

他の Stack からのリソース参照と依存関係を設定する。

**依存リソース**:
- Application Stack から ECS Cluster/Service の参照
- Application Stack から ALB の参照 (ログ用)
- VPC Stack から VPC の参照 (VPC Flow Logs 用)

**実装ファイル**: `lib/stack/ops-stack.ts`

### 環境別設定 (Dev/Prod) 🔵

**信頼性**: 🔵 *要件定義書 REQ-042より*

parameter.ts による環境別設定を各 Construct に適用する。

**Dev 環境設定**:
- ログ保持期間: 3 日
- S3 Glacier Export: 無効
- 手動承認フロー: 無効

**Prod 環境設定**:
- ログ保持期間: 30 日
- S3 Glacier Export: 有効
- 手動承認フロー: 有効 (オプション)

**実装ファイル**: `lib/stack/ops-stack.ts`, `parameter.ts`

### 全 Stack 統合テスト 🔵

**信頼性**: 🔵 *CDK ベストプラクティスより*

全 6 Stack が正しく連携することを確認する統合テストを実装する。

**テスト内容**:
- 全 Stack の CDK Synth 成功確認
- Stack 間参照の整合性確認
- 環境別設定の適用確認
- リソース間の依存関係確認

**実装ファイル**: `test/integration/all-stacks.test.ts`

---

## 基本的なテスト要件

### Ops Stack 作成テスト 🔵

**信頼性**: 🔵 *設計文書より*

- Ops Stack が作成されること
- 必要なリソースが全て含まれること

### Construct 統合テスト 🔵

**信頼性**: 🔵 *設計文書より*

- Log Group Construct が正しく統合されること
- Alarm Construct が正しく統合されること
- Chatbot Construct が正しく統合されること
- CI/CD Pipeline Construct が正しく統合されること

### 環境別設定テスト 🔵

**信頼性**: 🔵 *要件定義書 REQ-042より*

- Dev 環境で 3 日間のログ保持が設定されること
- Prod 環境で 30 日間のログ保持が設定されること
- 環境固有の設定が正しく適用されること

### 全 Stack 統合テスト 🔵

**信頼性**: 🔵 *CDK ベストプラクティスより*

- 全 6 Stack の CDK Synth が成功すること
- Stack 間の依存関係が正しく解決されること
- 循環参照が発生しないこと

### スナップショットテスト 🔵

**信頼性**: 🔵 *CDK ベストプラクティスより*

- Dev 環境のスナップショットテストが通過すること
- Prod 環境のスナップショットテストが通過すること
- 環境間の差異が意図通りであること

---

## 実装手順

### TDDタスクの場合

1. `/tsumiki:tdd-requirements TASK-0024` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 最終確認チェックリスト

### アーキテクチャ確認

- [ ] 6 Stack 構成 (VPC, Security, Database, Application, Distribution, Ops)
- [ ] Stack 間依存関係が設計通り
- [ ] 各 Stack の責務が明確に分離

### 環境確認

- [ ] Dev 環境設定が正しく反映
- [ ] Prod 環境設定が正しく反映
- [ ] 環境固有パラメータの切り替えが機能

### セキュリティ確認

- [ ] IAM ロールの最小権限原則
- [ ] 暗号化設定 (KMS, S3, Aurora)
- [ ] Security Group の適切な設定

### 運用確認

- [ ] ログ収集・保持設定
- [ ] アラーム・通知設定
- [ ] CI/CD パイプライン設定

---

## 信頼性レベルサマリー

- **総項目数**: 10項目
- 🔵 **青信号**: 10項目 (100%)
- 🟡 **黄信号**: 0項目 (0%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 高品質 - 全ての項目が要件定義書・設計文書により確認済み
